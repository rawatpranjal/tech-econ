{{ define "main" }}
<!-- Hero Section -->
<header class="hero hero-with-image hero-learning">
    <h1 class="hero-title">Learning</h1>
    <p class="hero-tagline">{{ len .Site.Data.resources }} books, courses, and blogs to level up your skills.</p>
</header>

<!-- Search Index Data for Fuse.js -->
<script id="search-data" type="application/json">
[{{ range $i, $item := .Site.Data.resources }}{{ if $i }},{{ end }}{"name":"{{ .name }}","description":"{{ .description | htmlEscape }}","domain":"{{ .domain }}","category":"{{ .category }}","type":"{{ .type }}"}{{ end }}]
</script>

<!-- Domain-Category Mapping for Cascade Filter -->
<script id="domain-categories" type="application/json">
{{ $domainCats := dict }}
{{ range .Site.Data.resources }}
    {{ $domain := .domain | default "" }}
    {{ $cat := .category }}
    {{ if and $domain (not (index $domainCats $domain)) }}
        {{ $domainCats = merge $domainCats (dict $domain (slice $cat)) }}
    {{ else if $domain }}
        {{ $existing := index $domainCats $domain }}
        {{ if not (in $existing $cat) }}
            {{ $domainCats = merge $domainCats (dict $domain ($existing | append $cat)) }}
        {{ end }}
    {{ end }}
{{ end }}
{{ $domainCats | jsonify }}
</script>

<div class="container">
    <!-- Search and Filters Row -->
    <div class="search-filters-row">
        <!-- Search Bar -->
        <div class="search-container">
            <div class="search-input-wrapper">
                <svg class="search-icon" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <input type="text"
                       id="resource-search"
                       class="search-input"
                       placeholder="Search resources..."
                       autocomplete="off">
                <button id="clear-search" class="clear-btn" type="button" aria-label="Clear search">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Domain Dropdown -->
        {{ $domains := slice }}
        {{ range .Site.Data.resources }}
            {{ if not (in $domains .domain) }}
                {{ $domains = $domains | append .domain }}
            {{ end }}
        {{ end }}
        <select id="domain-select" class="domain-select">
            <option value="all">All Domains</option>
            {{ range $dom := sort $domains }}
            <option value="{{ $dom }}">{{ $dom }}</option>
            {{ end }}
        </select>

        <!-- Category Dropdown -->
        {{ $categories := slice }}
        {{ range .Site.Data.resources }}
            {{ if not (in $categories .category) }}
                {{ $categories = $categories | append .category }}
            {{ end }}
        {{ end }}
        <select id="category-select" class="category-select">
            <option value="all">All Categories</option>
            {{ range $cat := sort $categories }}
            <option value="{{ $cat }}">{{ $cat }}</option>
            {{ end }}
        </select>
    </div>

    <div class="learning-meta-row">
        <div id="result-count" class="result-count">{{ len .Site.Data.resources }} resources</div>
    </div>

    <!-- Resources Grid - Grouped by Domain then Category -->
    <div id="resources-view" class="resources-grid">
        {{ range $domain := $domains }}
        <div class="domain-section" data-domain="{{ $domain }}">
            <h2 class="domain-title">{{ $domain }}</h2>
            <div class="domain-content">
                {{ $domainCategories := slice }}
                {{ range $.Site.Data.resources }}
                    {{ if eq .domain $domain }}
                        {{ if not (in $domainCategories .category) }}
                            {{ $domainCategories = $domainCategories | append .category }}
                        {{ end }}
                    {{ end }}
                {{ end }}

                {{ range $cat := sort $domainCategories }}
                <div class="category-section" data-section-category="{{ $cat }}" data-domain="{{ $domain }}">
                    <h3 class="category-title">{{ $cat }}</h3>
                    <div class="cards-row">
                        {{ range $.Site.Data.resources }}
                        {{ if and (eq .domain $domain) (eq .category $cat) }}
                        <div class="resource-card"
                             data-name="{{ .name | lower }}"
                             data-description="{{ .description | lower }}"
                             data-category="{{ .category }}"
                             data-domain="{{ .domain }}">
                            <div class="card-header">
                                <img class="resource-favicon lazy-favicon"
                                     data-src="https://www.google.com/s2/favicons?domain={{ .url | replaceRE "^https?://([^/]+).*" "$1" }}&sz=32"
                                     alt=""
                                     onerror="this.style.display='none'">
                                <h3 class="resource-name">
                                    <a href="{{ .url }}" target="_blank" rel="noopener">{{ .name }}</a>
                                </h3>
                                <span class="resource-type">{{ .type }}</span>
                            </div>
                            <p class="resource-desc">{{ .description }}</p>
                            <div class="card-footer">
                                <span class="category-badge">{{ .category }}</span>
                                <a href="{{ .url }}" target="_blank" class="link-btn">Visit</a>
                            </div>
                        </div>
                        {{ end }}
                        {{ end }}
                    </div>
                </div>
                {{ end }}
            </div>
        </div>
        {{ end }}
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>Curated learning resources for practitioners and data scientists</p>
    </footer>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Domain-Category cascade filter
    var domainSelect = document.getElementById('domain-select');
    var categorySelect = document.getElementById('category-select');
    var domainCategoriesData = JSON.parse(document.getElementById('domain-categories').textContent);
    var allCategoryOptions = Array.from(categorySelect.options).slice(1).map(function(opt) {
        return { value: opt.value, text: opt.text };
    });

    domainSelect.addEventListener('change', function() {
        var selectedDomain = this.value;

        // Reset category dropdown
        categorySelect.innerHTML = '<option value="all">All Categories</option>';

        if (selectedDomain === 'all') {
            // Restore all categories
            allCategoryOptions.forEach(function(opt) {
                var option = document.createElement('option');
                option.value = opt.value;
                option.text = opt.text;
                categorySelect.appendChild(option);
            });
        } else {
            // Filter categories for selected domain
            var domainCategories = domainCategoriesData[selectedDomain] || [];
            allCategoryOptions.forEach(function(opt) {
                if (domainCategories.indexOf(opt.value) !== -1) {
                    var option = document.createElement('option');
                    option.value = opt.value;
                    option.text = opt.text;
                    categorySelect.appendChild(option);
                }
            });
        }

        // Filter domain sections
        filterResources();
    });

    categorySelect.addEventListener('change', filterResources);

    function filterResources() {
        var selectedDomain = domainSelect.value;
        var selectedCategory = categorySelect.value;
        var visibleCount = 0;

        // Show/hide domain sections
        document.querySelectorAll('.domain-section').forEach(function(section) {
            var domainName = section.dataset.domain;
            var shouldShowDomain = selectedDomain === 'all' || domainName === selectedDomain;
            section.style.display = shouldShowDomain ? '' : 'none';

            if (shouldShowDomain) {
                // Show/hide category sections within domain
                section.querySelectorAll('.category-section').forEach(function(catSection) {
                    var catName = catSection.dataset.sectionCategory;
                    var shouldShowCat = selectedCategory === 'all' || catName === selectedCategory;
                    catSection.style.display = shouldShowCat ? '' : 'none';

                    if (shouldShowCat) {
                        visibleCount += catSection.querySelectorAll('.resource-card').length;
                    }
                });
            }
        });

        // Update result count
        document.getElementById('result-count').textContent = visibleCount + ' resources';
    }

    // Lazy load favicons with Intersection Observer
    var faviconObserver = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry) {
            if (entry.isIntersecting) {
                var img = entry.target;
                if (img.dataset.src) {
                    img.src = img.dataset.src;
                    img.removeAttribute('data-src');
                }
                faviconObserver.unobserve(img);
            }
        });
    }, { rootMargin: '200px' });

    document.querySelectorAll('.lazy-favicon').forEach(function(img) {
        faviconObserver.observe(img);
    });

    // Defer PageSearch initialization until idle
    var pageSearchConfig = {
        searchInputId: 'resource-search',
        cardSelector: '.resource-card',
        sectionSelector: '.category-section',
        domainSectionSelector: '.domain-section',
        itemLabel: 'resources',
        fuseKeys: [
            { name: 'name', weight: 2 },
            { name: 'description', weight: 1 },
            { name: 'type', weight: 0.8 },
            { name: 'domain', weight: 0.5 },
            { name: 'category', weight: 0.5 }
        ]
    };

    var pageSearchInstance = null;
    function initPageSearch() {
        if (!pageSearchInstance) {
            pageSearchInstance = new PageSearch(pageSearchConfig);
        }
    }

    // Initialize on idle or when user focuses search
    if ('requestIdleCallback' in window) {
        requestIdleCallback(initPageSearch, { timeout: 2000 });
    } else {
        setTimeout(initPageSearch, 100);
    }

    // Also init immediately if user interacts with search
    document.getElementById('resource-search').addEventListener('focus', initPageSearch, { once: true });
});
</script>
{{ end }}
