{{ define "main" }}
<!-- Preconnect to Google for favicon loading -->
<link rel="preconnect" href="https://www.google.com" crossorigin>

<style>
/* Filter bar styles */
.learning-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: center;
    padding: 1.5rem 2rem;
    background: var(--bg-card);
    border-bottom: 1px solid var(--border-color);
    position: sticky;
    top: 60px;
    z-index: 100;
}

.learning-filters .search-container {
    flex: 1;
    min-width: 200px;
    max-width: 400px;
}

.learning-filters .filter-select {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--background);
    color: var(--text-primary);
    font-size: 0.9rem;
    cursor: pointer;
    min-width: 150px;
}

.learning-filters .filter-select:focus {
    outline: none;
    border-color: var(--accent);
}

/* Level filter pills */
.level-pills {
    display: flex;
    gap: 0.5rem;
}

.level-pill {
    padding: 0.4rem 0.8rem;
    border: 1px solid var(--border-color);
    border-radius: 20px;
    background: var(--background);
    color: var(--text-secondary);
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
}

.level-pill:hover {
    border-color: var(--accent);
}

.level-pill.active {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
}

/* Result count */
.learning-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 2rem;
}

.result-count {
    font-size: 0.9rem;
    color: var(--text-muted);
}

/* Learning card (based on explore-card) */
.learning-card {
    flex: 0 0 280px;
    min-width: 280px;
    max-width: 280px;
    height: 180px;
    background: var(--bg-card);
    border-radius: 12px;
    padding: 1.25rem;
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.15s;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    will-change: transform;
    contain: layout style paint;
    text-decoration: none;
    color: inherit;
}

.learning-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--accent), transparent);
    opacity: 0;
    transition: opacity 0.2s;
}

.learning-card:hover {
    transform: scale(1.03) translateY(-4px);
    box-shadow: 0 12px 32px rgba(0,0,0,0.15);
    border-color: var(--accent);
    z-index: 5;
}

.learning-card:hover::before {
    opacity: 1;
}

.learning-card-header {
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.learning-card-favicon {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    flex-shrink: 0;
}

.learning-card-title {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--text-primary);
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    margin: 0;
    flex: 1;
}

.learning-card-desc {
    font-size: 0.82rem;
    color: var(--text-secondary);
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    flex: 1;
    margin: 0;
}

.learning-card-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: auto;
    padding-top: 0.5rem;
}

.learning-card-type {
    font-size: 0.75rem;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    background: var(--bg-hover);
    color: var(--text-muted);
}

.learning-card-level {
    font-size: 0.7rem;
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    font-weight: 500;
}

.learning-card-level.beginner {
    background: #e8f5e9;
    color: #2e7d32;
}

.learning-card-level.intermediate {
    background: #fff3e0;
    color: #ef6c00;
}

.learning-card-level.advanced {
    background: #ffebee;
    color: #c62828;
}

/* Empty state for filtered rows */
.category-row.hidden {
    display: none;
}

.category-row.empty {
    display: none;
}
</style>

<!-- Hero Section -->
<header class="hero hero-with-image hero-learning">
    <h1 class="hero-title">Learning</h1>
    <p class="hero-tagline">{{ len .Site.Data.resources }} books, courses, and blogs to level up your skills.</p>
</header>

<!-- Filter Bar -->
<div class="learning-filters">
    <!-- Search -->
    <div class="search-container">
        <div class="search-input-wrapper">
            <svg class="search-icon" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input type="text" id="learning-search" class="search-input" placeholder="Search resources..." autocomplete="off">
        </div>
    </div>

    <!-- Macro Category Filter -->
    {{ $macros := slice }}
    {{ range .Site.Data.resources }}
        {{ if and .macro_category (not (in $macros .macro_category)) }}
            {{ $macros = $macros | append .macro_category }}
        {{ end }}
    {{ end }}
    <select id="macro-filter" class="filter-select">
        <option value="all">All Topics</option>
        {{ range $macro := sort $macros }}
        <option value="{{ $macro }}">{{ $macro }}</option>
        {{ end }}
    </select>

    <!-- Type Filter -->
    {{ $types := slice }}
    {{ range .Site.Data.resources }}
        {{ if and .type (not (in $types .type)) }}
            {{ $types = $types | append .type }}
        {{ end }}
    {{ end }}
    <select id="type-filter" class="filter-select">
        <option value="all">All Types</option>
        {{ range $t := sort $types }}
        <option value="{{ $t }}">{{ $t }}</option>
        {{ end }}
    </select>

    <!-- Level Pills -->
    <div class="level-pills">
        <button class="level-pill active" data-level="all">All Levels</button>
        <button class="level-pill" data-level="beginner">Beginner</button>
        <button class="level-pill" data-level="intermediate">Intermediate</button>
        <button class="level-pill" data-level="advanced">Advanced</button>
    </div>
</div>

<!-- Meta info -->
<div class="learning-meta">
    <span id="result-count" class="result-count">{{ len .Site.Data.resources }} resources</span>
</div>

<!-- Netflix-style Category Rows -->
<div class="explore-rows" id="learning-rows">
    {{ $categories := slice }}
    {{ range .Site.Data.resources }}
        {{ if and .category (not (in $categories .category)) }}
            {{ $categories = $categories | append .category }}
        {{ end }}
    {{ end }}

    {{ range $cat := sort $categories }}
    {{ $catResources := where $.Site.Data.resources "category" $cat }}
    {{ if gt (len $catResources) 0 }}
    {{ $firstResource := index $catResources 0 }}
    <div class="explore-row category-row"
         data-category="{{ $cat }}"
         data-macro="{{ $firstResource.macro_category }}">
        <div class="explore-row-header">
            <h2 class="explore-row-title">{{ $cat }}</h2>
            <span class="explore-row-count">{{ len $catResources }} resources</span>
        </div>
        <div class="explore-scroller-wrapper">
            <div class="explore-scroller">
                {{ range sort $catResources "model_score" "desc" }}
                <a href="{{ .url }}" target="_blank" rel="noopener"
                   class="learning-card"
                   data-name="{{ .name | lower }}"
                   data-desc="{{ .description | lower }}"
                   data-type="{{ .type }}"
                   data-level="{{ .difficulty | default "all" }}"
                   data-macro="{{ .macro_category }}">
                    <div class="learning-card-header">
                        <img class="learning-card-favicon lazy-favicon"
                             src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
                             data-src="https://www.google.com/s2/favicons?domain={{ .url | replaceRE "^https?://([^/]+).*" "$1" }}&sz=32"
                             alt=""
                             onerror="this.style.display='none'">
                        <h3 class="learning-card-title">{{ .name }}</h3>
                    </div>
                    <p class="learning-card-desc">{{ .description }}</p>
                    <div class="learning-card-footer">
                        <span class="learning-card-type">{{ .type }}</span>
                        {{ with .difficulty }}
                        <span class="learning-card-level {{ . }}">{{ . | title }}</span>
                        {{ end }}
                    </div>
                </a>
                {{ end }}
            </div>
            <button class="scroller-nav prev" aria-label="Scroll left">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 18l-6-6 6-6"/>
                </svg>
            </button>
            <button class="scroller-nav next" aria-label="Scroll right">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18l6-6-6-6"/>
                </svg>
            </button>
        </div>
    </div>
    {{ end }}
    {{ end }}
</div>

<!-- Footer -->
<footer class="footer" style="padding: 2rem; text-align: center;">
    <p style="color: var(--text-muted);">Curated learning resources for practitioners and data scientists</p>
</footer>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elements
    const searchInput = document.getElementById('learning-search');
    const macroFilter = document.getElementById('macro-filter');
    const typeFilter = document.getElementById('type-filter');
    const levelPills = document.querySelectorAll('.level-pill');
    const categoryRows = document.querySelectorAll('.category-row');
    const resultCount = document.getElementById('result-count');

    let currentLevel = 'all';

    // Level pill click handlers
    levelPills.forEach(pill => {
        pill.addEventListener('click', function() {
            levelPills.forEach(p => p.classList.remove('active'));
            this.classList.add('active');
            currentLevel = this.dataset.level;
            filterAll();
        });
    });

    // Filter handlers
    macroFilter.addEventListener('change', filterAll);
    typeFilter.addEventListener('change', filterAll);
    searchInput.addEventListener('input', debounce(filterAll, 150));

    function filterAll() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const selectedMacro = macroFilter.value;
        const selectedType = typeFilter.value;
        let visibleCount = 0;

        categoryRows.forEach(row => {
            const rowMacro = row.dataset.macro;

            // First check if macro matches (hide entire row if not)
            if (selectedMacro !== 'all' && rowMacro !== selectedMacro) {
                row.classList.add('hidden');
                return;
            }

            // Filter cards within row
            const cards = row.querySelectorAll('.learning-card');
            let visibleInRow = 0;

            cards.forEach(card => {
                const cardType = card.dataset.type;
                const cardLevel = card.dataset.level;
                const cardName = card.dataset.name;
                const cardDesc = card.dataset.desc;

                let show = true;

                // Type filter
                if (selectedType !== 'all' && cardType !== selectedType) {
                    show = false;
                }

                // Level filter
                if (currentLevel !== 'all' && cardLevel !== currentLevel && cardLevel !== 'all') {
                    show = false;
                }

                // Search filter
                if (searchTerm && !cardName.includes(searchTerm) && !cardDesc.includes(searchTerm)) {
                    show = false;
                }

                card.style.display = show ? '' : 'none';
                if (show) {
                    visibleInRow++;
                    visibleCount++;
                }
            });

            // Hide row if no visible cards
            if (visibleInRow === 0) {
                row.classList.add('hidden');
            } else {
                row.classList.remove('hidden');
                // Update row count
                const countEl = row.querySelector('.explore-row-count');
                if (countEl) {
                    countEl.textContent = visibleInRow + ' resources';
                }
            }
        });

        resultCount.textContent = visibleCount + ' resources';
    }

    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    // Scroller navigation
    document.querySelectorAll('.explore-row').forEach(row => {
        const scroller = row.querySelector('.explore-scroller');
        const prevBtn = row.querySelector('.scroller-nav.prev');
        const nextBtn = row.querySelector('.scroller-nav.next');

        if (!scroller || !prevBtn || !nextBtn) return;

        function updateNavState() {
            const atStart = scroller.scrollLeft <= 0;
            const atEnd = scroller.scrollLeft >= scroller.scrollWidth - scroller.clientWidth - 10;
            prevBtn.classList.toggle('disabled', atStart);
            nextBtn.classList.toggle('disabled', atEnd);
        }

        prevBtn.addEventListener('click', () => {
            scroller.scrollBy({ left: -300, behavior: 'smooth' });
        });

        nextBtn.addEventListener('click', () => {
            scroller.scrollBy({ left: 300, behavior: 'smooth' });
        });

        scroller.addEventListener('scroll', debounce(updateNavState, 50));
        updateNavState();
    });

    // Lazy load favicons
    const faviconObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                if (img.dataset.src) {
                    img.src = img.dataset.src;
                    img.removeAttribute('data-src');
                }
                faviconObserver.unobserve(img);
            }
        });
    }, { rootMargin: '500px' });

    document.querySelectorAll('.lazy-favicon').forEach(img => {
        faviconObserver.observe(img);
    });
});
</script>
{{ end }}
