{{ define "main" }}
<!-- Search Index Data for Fuse.js -->
<script id="search-data" type="application/json">
[{{ range $i, $item := .Site.Data.talks }}{{ if $i }},{{ end }}{"name":"{{ .name }}","description":"{{ .description | htmlEscape }}","category":"{{ .category }}","type":"{{ .type }}"}{{ end }}]
</script>

<div class="container">
    <!-- Search and Filters Row -->
    <div class="search-filters-row">
        <!-- Search Bar -->
        <div class="search-container">
            <div class="search-input-wrapper">
                <svg class="search-icon" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <input type="text"
                       id="talk-search"
                       class="search-input"
                       placeholder="Search talks..."
                       autocomplete="off">
                <button id="clear-search" class="clear-btn" type="button" aria-label="Clear search">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Category Dropdown -->
        {{ $categories := slice }}
        {{ range .Site.Data.talks }}
            {{ if not (in $categories .category) }}
                {{ $categories = $categories | append .category }}
            {{ end }}
        {{ end }}
        <select id="category-select" class="category-select">
            <option value="all">All Topics</option>
            {{ range $cat := sort $categories }}
            <option value="{{ $cat }}">{{ $cat }}</option>
            {{ end }}
        </select>

        <!-- Format Dropdown -->
        {{ $formats := slice }}
        {{ range .Site.Data.talks }}
            {{ if not (in $formats .type) }}
                {{ $formats = $formats | append .type }}
            {{ end }}
        {{ end }}
        <select id="format-select" class="category-select">
            <option value="all">All Formats</option>
            {{ range $fmt := sort $formats }}
            <option value="{{ $fmt | lower }}">{{ $fmt }}</option>
            {{ end }}
        </select>

        <!-- View Toggle -->
        <div class="view-toggle">
            <button id="btn-cards" class="toggle-btn active">Cards</button>
            <button id="btn-table" class="toggle-btn">Table</button>
        </div>
    </div>

    <div id="result-count" class="result-count">{{ len .Site.Data.talks }} talks</div>

    <!-- Cards View -->
    <div id="cards-view" class="resources-grid">
        {{ range $cat := $categories }}
        <div class="category-section" data-section-category="{{ $cat }}">
            <h2 class="category-title">{{ $cat }}</h2>
            <div class="cards-row">
                {{ range $.Site.Data.talks }}
                {{ if eq .category $cat }}
                <div class="resource-card" data-aos="fade-up"
                     data-name="{{ .name | lower }}"
                     data-description="{{ .description | lower }}"
                     data-category="{{ .category }}"
                     data-type="{{ .type | lower }}">
                    {{ if .image_url }}
                    <a href="{{ .url }}" target="_blank" class="talk-thumbnail-link">
                        <img src="{{ .image_url }}"
                             alt=""
                             class="talk-thumbnail"
                             loading="lazy">
                    </a>
                    {{ else if findRE "youtube\\.com|youtu\\.be" .url }}
                    {{ $videoId := replaceRE ".*(?:v=|youtu\\.be/)([^&?]+).*" "$1" .url }}
                    <a href="{{ .url }}" target="_blank" class="talk-thumbnail-link">
                        <img src="https://img.youtube.com/vi/{{ $videoId }}/mqdefault.jpg"
                             alt=""
                             class="talk-thumbnail"
                             loading="lazy">
                        <div class="play-overlay">
                            <svg viewBox="0 0 24 24" width="48" height="48" fill="white">
                                <polygon points="5,3 19,12 5,21"></polygon>
                            </svg>
                        </div>
                    </a>
                    {{ end }}
                    <div class="card-header">
                        <img class="resource-favicon"
                             src="https://www.google.com/s2/favicons?domain={{ .url | replaceRE "^https?://([^/]+).*" "$1" }}&sz=32"
                             alt=""
                             loading="lazy"
                             onerror="this.style.display='none'">
                        <h3 class="resource-name">
                            <a href="{{ .url }}" target="_blank" rel="noopener">{{ .name }}</a>
                        </h3>
                        <span class="resource-type">{{ .type }}</span>
                    </div>
                    <p class="resource-desc">{{ .description }}</p>
                    <div class="card-footer">
                        <span class="category-badge">{{ .category }}</span>
                        <a href="{{ .url }}" target="_blank" class="link-btn">Visit</a>
                    </div>
                </div>
                {{ end }}
                {{ end }}
            </div>
        </div>
        {{ end }}
    </div>

    <!-- Table View -->
    <div id="table-view" class="package-table-wrapper" style="display: none;">
        <table class="package-table" id="talks-table">
            <thead>
                <tr>
                    <th class="sortable" data-sort="name">Name <span class="sort-icon">↕</span></th>
                    <th class="sortable" data-sort="type">Format <span class="sort-icon">↕</span></th>
                    <th class="sortable" data-sort="category">Topic <span class="sort-icon">↕</span></th>
                    <th>Description</th>
                    <th>Link</th>
                </tr>
            </thead>
            <tbody>
                {{ range .Site.Data.talks }}
                <tr data-name="{{ .name | lower }}"
                    data-description="{{ .description | lower }}"
                    data-category="{{ .category }}"
                    data-type="{{ .type | lower }}">
                    <td class="pkg-name">
                        <a href="{{ .url }}" target="_blank" rel="noopener">{{ .name }}</a>
                    </td>
                    <td><span class="category-badge-sm">{{ .type }}</span></td>
                    <td><span class="category-badge-sm">{{ .category }}</span></td>
                    <td class="pkg-desc">{{ .description }}</td>
                    <td class="pkg-links">
                        <a href="{{ .url }}" target="_blank">Visit</a>
                    </td>
                </tr>
                {{ end }}
            </tbody>
        </table>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>Curated talks, podcasts, and interviews for tech economists</p>
    </footer>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize PageSearch with Fuse.js
    new PageSearch({
        searchInputId: 'talk-search',
        cardSelector: '.resource-card',
        sectionSelector: '.category-section',
        tableRowSelector: '#talks-table tbody tr',
        itemLabel: 'talks',
        fuseKeys: [
            { name: 'name', weight: 2 },
            { name: 'description', weight: 1 },
            { name: 'type', weight: 0.8 },
            { name: 'category', weight: 0.5 }
        ],
        extraFilters: [
            { selectId: 'format-select', dataKey: 'type' }
        ]
    });

    // View toggle (page-specific)
    const cardsView = document.getElementById('cards-view');
    const tableView = document.getElementById('table-view');
    const btnCards = document.getElementById('btn-cards');
    const btnTable = document.getElementById('btn-table');

    btnCards.addEventListener('click', function() {
        cardsView.style.display = 'block';
        tableView.style.display = 'none';
        btnCards.classList.add('active');
        btnTable.classList.remove('active');
    });

    btnTable.addEventListener('click', function() {
        cardsView.style.display = 'none';
        tableView.style.display = 'block';
        btnTable.classList.add('active');
        btnCards.classList.remove('active');
    });

    // Table sorting (page-specific)
    const sortableHeaders = document.querySelectorAll('.sortable');
    const tableRows = document.querySelectorAll('#talks-table tbody tr');
    let currentSort = { column: null, direction: 'asc' };

    sortableHeaders.forEach(function(header) {
        header.addEventListener('click', function() {
            const column = this.dataset.sort;
            const direction = (currentSort.column === column && currentSort.direction === 'asc') ? 'desc' : 'asc';
            currentSort = { column, direction };

            sortableHeaders.forEach(function(h) {
                h.querySelector('.sort-icon').textContent = '↕';
            });
            this.querySelector('.sort-icon').textContent = direction === 'asc' ? '↑' : '↓';

            const tbody = document.querySelector('#talks-table tbody');
            const rows = Array.from(tableRows);

            rows.sort(function(a, b) {
                let aVal = a.dataset[column] || '';
                let bVal = b.dataset[column] || '';
                return direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
            });

            rows.forEach(function(row) {
                tbody.appendChild(row);
            });
        });
    });
});
</script>
{{ end }}
