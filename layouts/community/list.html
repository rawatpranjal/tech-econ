{{ define "main" }}
{{ $conferences := where .Site.Data.community "category" "Conferences" }}
{{ $researchLabs := where .Site.Data.community "category" "Research Labs" }}
{{ $online := where .Site.Data.community "category" "Online" }}
{{ $meetups := where .Site.Data.community "category" "Meetups" }}
<!-- Hero Section -->
<header class="hero hero-with-image hero-community">
    <h1 class="hero-title">Community & Events</h1>
    <p class="hero-tagline">{{ len $conferences }} conferences ‚Ä¢ {{ len $researchLabs }} research labs ‚Ä¢ {{ len $online }} online communities ‚Ä¢ {{ len $meetups }} meetups</p>
</header>

<!-- Search Index Data for Fuse.js -->
<script id="search-data" type="application/json">
[{{ range $i, $item := .Site.Data.community }}{{ if $i }},{{ end }}{"name":"{{ .name }}","description":"{{ .description | htmlEscape }}","category":"{{ .category }}","location":"{{ .location | htmlEscape }}","dates":"{{ .dates }}","type":"{{ .type }}"}{{ end }}]
</script>

<div class="container">
    <!-- Search and Filters Row -->
    <div class="search-filters-row">
        <!-- Search Bar -->
        <div class="search-container">
            <div class="search-input-wrapper">
                <svg class="search-icon" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <input type="text"
                       id="community-search"
                       class="search-input"
                       placeholder="Search events and communities..."
                       autocomplete="off">
                <button id="clear-search" class="clear-btn" type="button" aria-label="Clear search">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Category Dropdown -->
        {{ $categoryOrder := slice "Conferences" "Research Labs" "Online" "Meetups" }}
        <select id="category-select" class="category-select">
            <option value="all">All Categories</option>
            {{ range $cat := $categoryOrder }}
            <option value="{{ $cat }}">{{ $cat }}</option>
            {{ end }}
        </select>

        <!-- View Toggle (large tabs) -->
        <div class="view-toggle view-toggle-large">
            <button id="btn-map" class="toggle-btn active">Map</button>
            <button id="btn-calendar" class="toggle-btn">Calendar</button>
            <button id="btn-cards" class="toggle-btn">Cards</button>
            <button id="btn-table" class="toggle-btn">Table</button>
        </div>
    </div>

    <div id="result-count" class="result-count">{{ len .Site.Data.community }} events & communities</div>

    <!-- Calendar View Container (hidden by default - Map is default) -->
    <div id="calendar-view" style="display: none;">
        <!-- Calendar Sub-Toggle -->
        <div class="calendar-sub-toggle">
            <button class="sub-btn active" data-subview="year">Year</button>
            <button class="sub-btn" data-subview="month">Month</button>
        </div>

        <!-- Year Sub-View -->
        <div id="year-subview">
        <!-- Subcategory Legend -->
        <div class="subcategory-legend">
            <div class="legend-item"><span class="legend-color experimentation"></span> Experimentation</div>
            <div class="legend-item"><span class="legend-color marketing-science"></span> Marketing</div>
            <div class="legend-item"><span class="legend-color pricing-revenue"></span> Pricing</div>
            <div class="legend-item"><span class="legend-color platforms-e-commerce"></span> Platforms</div>
            <div class="legend-item"><span class="legend-color statistics-analytics"></span> Statistics</div>
            <div class="legend-item"><span class="legend-color healthcare-economics"></span> Healthcare</div>
            <div class="legend-item"><span class="legend-color labor-finance"></span> Labor & Finance</div>
            <div class="legend-item"><span class="legend-color antitrust"></span> Antitrust</div>
            <div class="legend-item"><span class="legend-color market-design"></span> Market Design</div>
            <div class="legend-item"><span class="legend-color decision-science"></span> Decision Science</div>
            <div class="legend-item"><span class="legend-color sports-analytics"></span> Sports</div>
            <div class="legend-item"><span class="legend-color gaming-esports"></span> Gaming</div>
            <div class="legend-item"><span class="legend-color insurance-actuarial"></span> Insurance</div>
            <div class="legend-item"><span class="legend-color retail-cpg"></span> Retail</div>
            <div class="legend-item"><span class="legend-color supply-chain"></span> Supply Chain</div>
        </div>

        <div class="calendar-grid">
            {{ $months := slice "January" "February" "March" "April" "May" "June" "July" "August" "September" "October" "November" "December" }}
            {{ range $month := $months }}
            <div class="month-box">
                <div class="month-header">{{ $month }}</div>
                <div class="month-events">
                    {{ $hasEvents := false }}
                    {{ range $.Site.Data.community }}
                    {{ if and (ne .dates "Ongoing") (eq .category "Conferences") }}
                    {{ if or (findRE (printf "^%s" $month) .dates) (findRE (printf "-%s" $month) .dates) }}
                    {{ $hasEvents = true }}
                    {{ $subcatClass := .subcategory | default "" | urlize }}
                    <div class="month-event event-{{ $subcatClass }}" data-month="{{ $month }}">
                        <a href="{{ .url }}" target="_blank" rel="noopener">{{ .name }}</a>
                        <div class="event-tooltip">
                            <div class="tooltip-title">{{ .name }}</div>
                            <div class="tooltip-meta">
                                <span>üìç {{ .location }}</span>
                                <span>üìÖ {{ .dates }}</span>
                                {{ if .attendees }}<span>üë• {{ .attendees }}</span>{{ end }}
                            </div>
                            {{ if .subcategory }}<span class="tooltip-badge">{{ .subcategory }}</span>{{ end }}
                        </div>
                    </div>
                    {{ end }}
                    {{ end }}
                    {{ end }}
                    {{ if not $hasEvents }}
                    <span class="month-empty">No events</span>
                    {{ end }}
                </div>
            </div>
            {{ end }}
        </div>

        <!-- Research Labs (always cards) -->
        <div class="always-available">
            <h3>Research Labs</h3>
            <div class="cards-row">
                {{ range .Site.Data.community }}
                {{ if eq .category "Research Labs" }}
                <div class="resource-card"
                     data-name="{{ .name | lower }}"
                     data-description="{{ .description | lower }}"
                     data-category="{{ .category }}">
                    <div class="card-header">
                        <img class="resource-favicon"
                             src="https://www.google.com/s2/favicons?domain={{ .url | replaceRE "^https?://([^/]+).*" "$1" }}&sz=32"
                             alt=""
                             loading="lazy"
                             onerror="this.style.display='none'">
                        <h3 class="resource-name">
                            <a href="{{ .url }}" target="_blank" rel="noopener">{{ .name }}</a>
                        </h3>
                        <span class="resource-type">{{ .type }}</span>
                    </div>
                    <p class="resource-desc">{{ .description }}</p>
                    <div class="card-footer">
                        <span class="category-badge">{{ .category }}</span>
                        <a href="{{ .url }}" target="_blank" class="link-btn">Visit</a>
                    </div>
                </div>
                {{ end }}
                {{ end }}
            </div>
        </div>

        <!-- Online Communities (always cards) -->
        <div class="always-available">
            <h3>Online Communities</h3>
            <div class="cards-row">
                {{ range .Site.Data.community }}
                {{ if eq .category "Online" }}
                <div class="resource-card"
                     data-name="{{ .name | lower }}"
                     data-description="{{ .description | lower }}"
                     data-category="{{ .category }}">
                    <div class="card-header">
                        <img class="resource-favicon"
                             src="https://www.google.com/s2/favicons?domain={{ .url | replaceRE "^https?://([^/]+).*" "$1" }}&sz=32"
                             alt=""
                             loading="lazy"
                             onerror="this.style.display='none'">
                        <h3 class="resource-name">
                            <a href="{{ .url }}" target="_blank" rel="noopener">{{ .name }}</a>
                        </h3>
                        <span class="resource-type">{{ .type }}</span>
                    </div>
                    <p class="resource-desc">{{ .description }}</p>
                    <div class="card-footer">
                        <span class="category-badge">{{ .category }}</span>
                        <a href="{{ .url }}" target="_blank" class="link-btn">Visit</a>
                    </div>
                </div>
                {{ end }}
                {{ end }}
            </div>
        </div>

        <!-- Meetups (always cards, grouped by city) -->
        <div class="always-available">
            <h3>Meetups</h3>
            <div class="cards-row">
                {{ range .Site.Data.community }}
                {{ if eq .category "Meetups" }}
                <div class="resource-card"
                     data-name="{{ .name | lower }}"
                     data-description="{{ .description | lower }}"
                     data-category="{{ .category }}"
                     data-location="{{ .location | lower }}">
                    <div class="card-header">
                        <img class="resource-favicon"
                             src="https://www.google.com/s2/favicons?domain={{ .url | replaceRE "^https?://([^/]+).*" "$1" }}&sz=32"
                             alt=""
                             loading="lazy"
                             onerror="this.style.display='none'">
                        <h3 class="resource-name">
                            <a href="{{ .url }}" target="_blank" rel="noopener">{{ .name }}</a>
                        </h3>
                        <span class="resource-type">{{ .type }}</span>
                    </div>
                    <p class="resource-desc">{{ .description }}</p>
                    <div class="resource-meta">
                        <span class="meta-item">
                            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                            {{ .location }}
                        </span>
                    </div>
                    <div class="card-footer">
                        <span class="category-badge">{{ .type }}</span>
                        <a href="{{ .url }}" target="_blank" class="link-btn">Visit</a>
                    </div>
                </div>
                {{ end }}
                {{ end }}
            </div>
        </div>
        </div>

        <!-- Month Sub-View (hidden by default within Calendar) -->
        <div id="month-subview" style="display: none;">
        <div class="month-nav">
            <button id="prev-month" aria-label="Previous month">‚Üê</button>
            <div class="month-jump">
                <select id="month-select" aria-label="Select month">
                    <option value="0">January</option>
                    <option value="1">February</option>
                    <option value="2">March</option>
                    <option value="3">April</option>
                    <option value="4">May</option>
                    <option value="5">June</option>
                    <option value="6">July</option>
                    <option value="7">August</option>
                    <option value="8">September</option>
                    <option value="9">October</option>
                    <option value="10">November</option>
                    <option value="11">December</option>
                </select>
                <select id="year-select" aria-label="Select year">
                    <option value="2024">2024</option>
                    <option value="2025" selected>2025</option>
                    <option value="2026">2026</option>
                    <option value="2027">2027</option>
                </select>
            </div>
            <button id="next-month" aria-label="Next month">‚Üí</button>
        </div>

        <!-- Day of week headers -->
        <div class="calendar-header">
            <div>Sun</div>
            <div>Mon</div>
            <div>Tue</div>
            <div>Wed</div>
            <div>Thu</div>
            <div>Fri</div>
            <div>Sat</div>
        </div>

        <!-- Calendar days grid (6 rows x 7 cols = 42 cells) -->
        <div id="calendar-days" class="calendar-days-grid">
            <!-- Dynamically populated by JavaScript -->
        </div>

        <p id="no-month-events" class="no-events" style="display: none;">No conferences scheduled for this month.</p>
        </div>

        <!-- Conference Data for Calendar JavaScript -->
    <script id="conference-dates-data" type="application/json">
    [{{ $first := true }}{{ range .Site.Data.community }}{{ if and (eq .category "Conferences") .start_date }}{{ if not $first }},{{ end }}{{ $first = false }}{"name":"{{ .name }}","url":"{{ .url }}","start_date":"{{ .start_date }}","end_date":"{{ .end_date }}","subcategory":"{{ .subcategory | default "" }}","location":"{{ .location | htmlEscape }}"}{{ end }}{{ end }}]
    </script>
    </div>

    <!-- Map View (default view) -->
    <div id="map-view">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
        <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
        <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

        <!-- Map Controls -->
        <div class="map-controls">
            <button id="find-near-me" class="near-me-btn">üìç Find Near Me</button>
            <button id="map-fullscreen" class="fullscreen-btn" title="Toggle fullscreen">‚õ∂</button>
            <select id="map-category-filter" class="map-category-select">
                <option value="all">All Categories</option>
                <optgroup label="Conference Topics">
                    <option value="Experimentation">Experimentation</option>
                    <option value="Marketing Science">Marketing</option>
                    <option value="Pricing & Revenue">Pricing</option>
                    <option value="Platforms & E-commerce">Platforms</option>
                    <option value="Statistics & Analytics">Statistics</option>
                    <option value="Healthcare Economics">Healthcare</option>
                    <option value="Labor & Finance">Labor & Finance</option>
                    <option value="Antitrust">Antitrust</option>
                    <option value="Market Design">Market Design</option>
                    <option value="Decision Science">Decision Science</option>
                    <option value="Sports Analytics">Sports Analytics</option>
                    <option value="Gaming & Esports">Gaming & Esports</option>
                    <option value="Insurance & Actuarial">Insurance & Actuarial</option>
                    <option value="Retail & CPG">Retail & CPG</option>
                    <option value="Supply Chain">Supply Chain</option>
                </optgroup>
                <optgroup label="Other">
                    <option value="Meetups">Meetups</option>
                    <option value="Research Labs">Research Labs</option>
                </optgroup>
            </select>
            <div class="city-filter">
                <button class="city-btn active" data-city="all">All</button>
                <button class="city-btn" data-city="nyc">NYC</button>
                <button class="city-btn" data-city="sf">SF</button>
                <button class="city-btn" data-city="boston">Boston</button>
                <button class="city-btn" data-city="chicago">Chicago</button>
                <button class="city-btn" data-city="dc">DC</button>
                <button class="city-btn" data-city="la">LA</button>
                <button class="city-btn" data-city="seattle">Seattle</button>
                <button class="city-btn" data-city="austin">Austin</button>
                <button class="city-btn" data-city="denver">Denver</button>
                <button class="city-btn" data-city="atlanta">Atlanta</button>
                <button class="city-btn" data-city="toronto">Toronto</button>
                <button class="city-btn" data-city="montreal">Montreal</button>
            </div>
        </div>

        <!-- Subcategory Legend (clickable for filtering) -->
        <div class="subcategory-legend map-legend" id="map-legend">
            <div class="legend-item active" data-filter="Experimentation"><span class="legend-color experimentation"></span> Experimentation</div>
            <div class="legend-item active" data-filter="Marketing Science"><span class="legend-color marketing-science"></span> Marketing</div>
            <div class="legend-item active" data-filter="Pricing & Revenue"><span class="legend-color pricing-revenue"></span> Pricing</div>
            <div class="legend-item active" data-filter="Platforms & E-commerce"><span class="legend-color platforms-e-commerce"></span> Platforms</div>
            <div class="legend-item active" data-filter="Statistics & Analytics"><span class="legend-color statistics-analytics"></span> Statistics</div>
            <div class="legend-item active" data-filter="Healthcare Economics"><span class="legend-color healthcare-economics"></span> Healthcare</div>
            <div class="legend-item active" data-filter="Labor & Finance"><span class="legend-color labor-finance"></span> Labor & Finance</div>
            <div class="legend-item active" data-filter="Antitrust"><span class="legend-color antitrust"></span> Antitrust</div>
            <div class="legend-item active" data-filter="Market Design"><span class="legend-color market-design"></span> Market Design</div>
            <div class="legend-item active" data-filter="Decision Science"><span class="legend-color decision-science"></span> Decision</div>
            <div class="legend-item active" data-filter="Sports Analytics"><span class="legend-color sports-analytics"></span> Sports</div>
            <div class="legend-item active" data-filter="Gaming & Esports"><span class="legend-color gaming-esports"></span> Gaming</div>
            <div class="legend-item active" data-filter="Insurance & Actuarial"><span class="legend-color insurance-actuarial"></span> Insurance</div>
            <div class="legend-item active" data-filter="Retail & CPG"><span class="legend-color retail-cpg"></span> Retail</div>
            <div class="legend-item active" data-filter="Supply Chain"><span class="legend-color supply-chain"></span> Supply Chain</div>
            <div class="legend-item active" data-filter="Meetups"><span class="legend-color meetup"></span> Meetups</div>
            <div class="legend-item active" data-filter="Research Labs"><span class="legend-color research-lab"></span> Research Labs</div>
        </div>

        <div id="conference-map"></div>
        <p class="map-note">Showing {{ len (where .Site.Data.community "lat" "!=" nil) }} locations with coordinates. Events with "Various" or "Online" locations are not shown on map.</p>
    </div>

    <!-- Map Data for JavaScript -->
    <script id="map-data" type="application/json">
    [{{ $first := true }}{{ range .Site.Data.community }}{{ if and .lat .lng }}{{ if not $first }},{{ end }}{{ $first = false }}{"name":"{{ .name }}","url":"{{ .url }}","lat":{{ .lat }},"lng":{{ .lng }},"category":"{{ .category }}","subcategory":"{{ .subcategory | default "" }}","location":"{{ .location | htmlEscape }}","dates":"{{ .dates }}","start_date":"{{ .start_date | default "" }}","end_date":"{{ .end_date | default "" }}","attendees":"{{ .attendees | default "" }}","description":"{{ .description | htmlEscape | truncate 150 }}","type":"{{ .type }}"}{{ end }}{{ end }}]
    </script>

    <!-- Cards View (hidden by default) -->
    <div id="cards-view" style="display: none;">
        <div class="resources-grid">
            {{ range $cat := $categoryOrder }}
            <div class="category-section" data-section-category="{{ $cat }}">
                <h2 class="category-title">{{ $cat }}</h2>
                <div class="cards-row">
                    {{ range $.Site.Data.community }}
                    {{ if eq .category $cat }}
                    <div class="resource-card" data-aos="fade-up"
                         data-name="{{ .name | lower }}"
                         data-description="{{ .description | lower }}"
                         data-category="{{ .category }}"
                         data-location="{{ .location | lower }}"
                         data-dates="{{ .dates | lower }}"
                         data-subcategory="{{ .subcategory | default "" | lower }}">
                        <div class="card-header">
                            <img class="resource-favicon"
                                 src="https://www.google.com/s2/favicons?domain={{ .url | replaceRE "^https?://([^/]+).*" "$1" }}&sz=32"
                                 alt=""
                                 loading="lazy"
                                 onerror="this.style.display='none'">
                            <h3 class="resource-name">
                                <a href="{{ .url }}" target="_blank" rel="noopener">{{ .name }}</a>
                            </h3>
                            <span class="resource-type">{{ .type }}</span>
                        </div>
                        {{ if .best_for }}<p class="resource-best-for">Best for: {{ .best_for }}</p>{{ end }}
                        <p class="resource-desc">{{ .description }}</p>
                        <div class="resource-meta">
                            <span class="meta-item">
                                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                    <circle cx="12" cy="10" r="3"></circle>
                                </svg>
                                {{ .location }}
                            </span>
                            <span class="meta-item">
                                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                                {{ .dates }}
                            </span>
                            {{ if .attendees }}
                            <span class="meta-item attendees-badge">
                                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                </svg>
                                {{ .attendees }}
                            </span>
                            {{ end }}
                        </div>
                        <div class="card-footer">
                            {{ if .subcategory }}<span class="subcategory-badge">{{ .subcategory }}</span>{{ else }}<span class="category-badge">{{ .category }}</span>{{ end }}
                            <a href="{{ .url }}" target="_blank" class="link-btn">Visit</a>
                        </div>
                    </div>
                    {{ end }}
                    {{ end }}
                </div>
            </div>
            {{ end }}
        </div>
    </div>

    <!-- Table View (hidden by default) -->
    <div id="table-view" style="display: none;">
        <div class="table-container">
            <table class="community-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Dates</th>
                        <th>Location</th>
                        <th>Category</th>
                        <th>Subcategory</th>
                        <th>Attendees</th>
                    </tr>
                </thead>
                <tbody>
                    {{ range .Site.Data.community }}
                    <tr data-category="{{ .category }}" data-name="{{ .name | lower }}" data-location="{{ .location | lower }}">
                        <td><a href="{{ .url }}" target="_blank" rel="noopener">{{ .name }}</a></td>
                        <td>{{ .dates }}</td>
                        <td>{{ .location }}</td>
                        <td>{{ .category }}</td>
                        <td>{{ .subcategory | default "‚Äî" }}</td>
                        <td>{{ .attendees | default "‚Äî" }}</td>
                    </tr>
                    {{ end }}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>Community resources for tech economists</p>
    </footer>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize PageSearch with Fuse.js
    new PageSearch({
        searchInputId: 'community-search',
        cardSelector: '#cards-view .resource-card',
        sectionSelector: '#cards-view .category-section',
        itemLabel: 'events & communities',
        fuseKeys: [
            { name: 'name', weight: 2 },
            { name: 'description', weight: 1 },
            { name: 'location', weight: 0.8 },
            { name: 'dates', weight: 0.5 },
            { name: 'category', weight: 0.5 }
        ]
    });

    // View elements
    const calendarView = document.getElementById('calendar-view');
    const yearSubview = document.getElementById('year-subview');
    const monthSubview = document.getElementById('month-subview');
    const mapView = document.getElementById('map-view');
    const cardsView = document.getElementById('cards-view');
    const tableView = document.getElementById('table-view');
    const btnMap = document.getElementById('btn-map');
    const btnCalendar = document.getElementById('btn-calendar');
    const btnCards = document.getElementById('btn-cards');
    const btnTable = document.getElementById('btn-table');

    // Map variables
    let map = null;
    let markers = null;

    // Subcategory colors matching CSS
    const subcategoryColors = {
        'Experimentation': '#10b981',
        'Marketing Science': '#8b5cf6',
        'Pricing & Revenue': '#f59e0b',
        'Platforms & E-commerce': '#3b82f6',
        'Statistics & Analytics': '#6366f1',
        'Healthcare Economics': '#ec4899',
        'Labor & Finance': '#14b8a6',
        'Antitrust': '#ef4444',
        'Market Design': '#f97316',
        'Decision Science': '#7c3aed',
        'Sports Analytics': '#84cc16',
        'Gaming & Esports': '#a855f7',
        'Insurance & Actuarial': '#06b6d4',
        'Retail & CPG': '#eab308',
        'Supply Chain': '#78716c'
    };

    // Category colors for non-conference items
    const categoryColors = {
        'Meetups': '#22c55e',
        'Research Labs': '#0ea5e9'
    };

    function getMarkerColor(item) {
        if (item.category === 'Meetups') return categoryColors['Meetups'];
        if (item.category === 'Research Labs') return categoryColors['Research Labs'];
        return subcategoryColors[item.subcategory] || '#6b7280';
    }

    // Format date range nicely (e.g., "Jan 3-5, 2025")
    function formatDateRange(startDate, endDate) {
        if (!startDate) return '';
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const start = new Date(startDate + 'T00:00:00');
        const end = endDate ? new Date(endDate + 'T00:00:00') : start;

        const startMonth = months[start.getMonth()];
        const endMonth = months[end.getMonth()];
        const startDay = start.getDate();
        const endDay = end.getDate();
        const year = start.getFullYear();

        if (startDate === endDate) {
            return `${startMonth} ${startDay}, ${year}`;
        } else if (startMonth === endMonth) {
            return `${startMonth} ${startDay}-${endDay}, ${year}`;
        } else {
            return `${startMonth} ${startDay} - ${endMonth} ${endDay}, ${year}`;
        }
    }

    function createCustomIcon(color) {
        return L.divIcon({
            className: 'custom-marker',
            html: `<div style="background-color: ${color}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
            iconSize: [16, 16],
            iconAnchor: [8, 8],
            popupAnchor: [0, -8]
        });
    }

    function initMap() {
        if (map) return; // Already initialized

        // Create map centered on US
        map = L.map('conference-map').setView([39.8283, -98.5795], 4);

        // Add CartoDB Positron tiles (cleaner, softer look)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/">CARTO</a>',
            maxZoom: 19,
            subdomains: 'abcd'
        }).addTo(map);

        // Create marker cluster group with custom styling
        markers = L.markerClusterGroup({
            maxClusterRadius: 35,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true,
            iconCreateFunction: function(cluster) {
                const count = cluster.getChildCount();
                let size = 'small';
                if (count >= 10) size = 'medium';
                if (count >= 25) size = 'large';
                return L.divIcon({
                    html: `<div class="cluster-${size}"><span>${count}</span></div>`,
                    className: 'custom-cluster',
                    iconSize: L.point(40, 40)
                });
            }
        });

        // Load and add markers from map data
        const mapDataEl = document.getElementById('map-data');
        if (mapDataEl) {
            try {
                const data = JSON.parse(mapDataEl.textContent);
                data.forEach(item => {
                    const color = getMarkerColor(item);
                    const icon = createCustomIcon(color);

                    const marker = L.marker([item.lat, item.lng], { icon: icon });

                    // Format dates
                    const dateDisplay = item.start_date
                        ? formatDateRange(item.start_date, item.end_date)
                        : item.dates;

                    // Create rich popup content
                    let popupContent = `
                        <div class="map-popup">
                            <strong class="popup-title">
                                <a href="${item.url}" target="_blank" rel="noopener">${item.name}</a>
                            </strong>
                            ${item.description ? `<p class="popup-desc">${item.description}</p>` : ''}
                            <div class="popup-meta">
                                <span>üìç ${item.location}</span>
                                ${dateDisplay ? `<span>üìÖ ${dateDisplay}</span>` : ''}
                                ${item.attendees ? `<span>üë• ${item.attendees} attendees</span>` : ''}
                            </div>
                            <div class="popup-footer">
                                <span class="popup-badge" style="background-color: ${color}; color: white;">
                                    ${item.subcategory || item.category}
                                </span>
                                <a href="${item.url}" target="_blank" rel="noopener" class="popup-link">Visit Website ‚Üí</a>
                            </div>
                        </div>
                    `;

                    marker.bindPopup(popupContent, { maxWidth: 300 });
                    markers.addLayer(marker);
                });

                map.addLayer(markers);
                // Keep US-focused view (don't fitBounds to include international)
            } catch (e) {
                console.error('Error loading map data:', e);
            }
        }

        // Set up city filter buttons
        setupCityFilter();
        // Set up "Near Me" button
        setupNearMe();
    }

    // City coordinates for quick navigation
    const cityCoordinates = {
        'all': { lat: 39.8283, lng: -98.5795, zoom: 4 },
        'nyc': { lat: 40.7128, lng: -74.0060, zoom: 10 },
        'sf': { lat: 37.7749, lng: -122.4194, zoom: 9 },
        'boston': { lat: 42.3601, lng: -71.0589, zoom: 10 },
        'chicago': { lat: 41.8781, lng: -87.6298, zoom: 10 },
        'dc': { lat: 38.9072, lng: -77.0369, zoom: 10 },
        'la': { lat: 34.0522, lng: -118.2437, zoom: 9 },
        'seattle': { lat: 47.6062, lng: -122.3321, zoom: 10 },
        'austin': { lat: 30.2672, lng: -97.7431, zoom: 10 },
        'denver': { lat: 39.7392, lng: -104.9903, zoom: 10 },
        'atlanta': { lat: 33.7490, lng: -84.3880, zoom: 10 },
        'toronto': { lat: 43.6532, lng: -79.3832, zoom: 10 },
        'montreal': { lat: 45.5017, lng: -73.5673, zoom: 10 }
    };

    // Fullscreen toggle
    const fullscreenBtn = document.getElementById('map-fullscreen');
    const mapContainer = document.getElementById('map-view');
    let isFullscreen = false;

    if (fullscreenBtn) {
        fullscreenBtn.addEventListener('click', function() {
            isFullscreen = !isFullscreen;
            if (isFullscreen) {
                mapContainer.classList.add('map-fullscreen');
                fullscreenBtn.textContent = '‚úï';
                fullscreenBtn.title = 'Exit fullscreen';
                document.body.style.overflow = 'hidden';
            } else {
                mapContainer.classList.remove('map-fullscreen');
                fullscreenBtn.textContent = '‚õ∂';
                fullscreenBtn.title = 'Toggle fullscreen';
                document.body.style.overflow = '';
            }
            // Invalidate map size after transition
            setTimeout(() => {
                if (map) map.invalidateSize();
            }, 300);
        });

        // ESC key to exit fullscreen
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && isFullscreen) {
                fullscreenBtn.click();
            }
        });
    }

    let userMarker = null;

    function setupCityFilter() {
        const cityBtns = document.querySelectorAll('.city-btn');
        cityBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                // Update active state
                cityBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                // Zoom to city
                const city = this.dataset.city;
                const coords = cityCoordinates[city];
                if (coords && map) {
                    map.setView([coords.lat, coords.lng], coords.zoom);
                }
            });
        });
    }

    function setupNearMe() {
        const nearMeBtn = document.getElementById('find-near-me');
        if (!nearMeBtn) return;

        nearMeBtn.addEventListener('click', function() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser');
                return;
            }

            nearMeBtn.textContent = 'üìç Locating...';
            nearMeBtn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;

                    // Zoom to user location
                    if (map) {
                        map.setView([userLat, userLng], 8);

                        // Remove previous user marker if exists
                        if (userMarker) {
                            map.removeLayer(userMarker);
                        }

                        // Add pulsing marker at user location
                        userMarker = L.marker([userLat, userLng], {
                            icon: L.divIcon({
                                className: 'user-location-marker',
                                html: '<div class="user-pulse"></div><div class="user-dot"></div>',
                                iconSize: [20, 20],
                                iconAnchor: [10, 10]
                            })
                        }).addTo(map);
                        userMarker.bindPopup('üìç You are here').openPopup();

                        // Clear city filter active state
                        document.querySelectorAll('.city-btn').forEach(b => b.classList.remove('active'));
                    }

                    nearMeBtn.textContent = 'üìç Find Near Me';
                    nearMeBtn.disabled = false;
                },
                (error) => {
                    let msg = 'Unable to get your location';
                    if (error.code === error.PERMISSION_DENIED) {
                        msg = 'Location access denied. Please enable location in your browser.';
                    }
                    alert(msg);
                    nearMeBtn.textContent = 'üìç Find Near Me';
                    nearMeBtn.disabled = false;
                },
                { timeout: 10000, enableHighAccuracy: false }
            );
        });
    }

    // Calendar state
    const months = ['January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'];
    const today = new Date();
    let currentYear = today.getFullYear();
    let currentMonthIndex = today.getMonth();
    const monthSelect = document.getElementById('month-select');
    const yearSelect = document.getElementById('year-select');
    const calendarDaysContainer = document.getElementById('calendar-days');
    const noEventsMsg = document.getElementById('no-month-events');

    // Load conference dates data
    let conferenceData = [];
    const confDataEl = document.getElementById('conference-dates-data');
    if (confDataEl) {
        try {
            conferenceData = JSON.parse(confDataEl.textContent);
        } catch (e) {
            console.error('Error parsing conference dates:', e);
        }
    }

    // Get events for a specific date
    function getEventsForDate(year, month, day) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        return conferenceData.filter(conf => {
            const start = conf.start_date;
            const end = conf.end_date;
            return dateStr >= start && dateStr <= end;
        });
    }

    // Get color for subcategory
    function getEventColor(subcategory) {
        return subcategoryColors[subcategory] || '#6b7280';
    }

    // Render calendar grid for current month
    function renderCalendarMonth() {
        const year = currentYear;
        const month = currentMonthIndex;

        // Update dropdowns
        if (monthSelect) monthSelect.value = month;
        if (yearSelect) yearSelect.value = year;

        // Clear grid
        calendarDaysContainer.innerHTML = '';

        // Get first day of month and total days
        const firstDay = new Date(year, month, 1).getDay(); // 0 = Sunday
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const daysInPrevMonth = new Date(year, month, 0).getDate();

        // Create 42 cells (6 weeks x 7 days)
        let dayNum = 1;
        let nextMonthDay = 1;
        let hasEvents = false;

        for (let i = 0; i < 42; i++) {
            const cell = document.createElement('div');
            cell.className = 'calendar-day';

            // Weekend shading (0 = Sunday, 6 = Saturday)
            const dayOfWeek = i % 7;
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                cell.classList.add('weekend');
            }

            let displayDay;
            let isCurrentMonth = true;
            let cellYear = year;
            let cellMonth = month;

            if (i < firstDay) {
                // Previous month days
                displayDay = daysInPrevMonth - firstDay + i + 1;
                isCurrentMonth = false;
                cellMonth = month - 1;
                if (cellMonth < 0) {
                    cellMonth = 11;
                    cellYear = year - 1;
                }
                cell.classList.add('other-month');
            } else if (dayNum > daysInMonth) {
                // Next month days
                displayDay = nextMonthDay++;
                isCurrentMonth = false;
                cellMonth = month + 1;
                if (cellMonth > 11) {
                    cellMonth = 0;
                    cellYear = year + 1;
                }
                cell.classList.add('other-month');
            } else {
                displayDay = dayNum++;

                // Today highlighting
                if (cellYear === today.getFullYear() &&
                    cellMonth === today.getMonth() &&
                    displayDay === today.getDate()) {
                    cell.classList.add('today');
                }
            }

            // Day number
            const dayNumEl = document.createElement('span');
            dayNumEl.className = 'day-number';
            dayNumEl.textContent = displayDay;
            cell.appendChild(dayNumEl);

            // Get events for this day
            const events = getEventsForDate(cellYear, cellMonth, displayDay);
            if (events.length > 0 && isCurrentMonth) {
                hasEvents = true;
                const eventsContainer = document.createElement('div');
                eventsContainer.className = 'day-events';

                events.slice(0, 3).forEach(event => {
                    const pill = document.createElement('a');
                    pill.className = 'event-pill';
                    pill.href = event.url;
                    pill.target = '_blank';
                    pill.rel = 'noopener';
                    pill.textContent = event.name;
                    pill.style.backgroundColor = getEventColor(event.subcategory);
                    pill.title = `${event.name}\n${event.location}\n${event.start_date} to ${event.end_date}`;
                    eventsContainer.appendChild(pill);
                });

                if (events.length > 3) {
                    const more = document.createElement('span');
                    more.className = 'more-events';
                    more.textContent = `+${events.length - 3} more`;
                    eventsContainer.appendChild(more);
                }

                cell.appendChild(eventsContainer);
            }

            calendarDaysContainer.appendChild(cell);
        }

        // Show/hide no events message
        noEventsMsg.style.display = hasEvents ? 'none' : 'block';
    }

    // Update month view wrapper
    function updateMonthView() {
        renderCalendarMonth();
    }

    // View toggle handlers
    function setActiveView(view) {
        // Hide all main views
        calendarView.style.display = 'none';
        mapView.style.display = 'none';
        cardsView.style.display = 'none';
        tableView.style.display = 'none';

        // Remove active from all buttons
        btnMap.classList.remove('active');
        btnCalendar.classList.remove('active');
        btnCards.classList.remove('active');
        btnTable.classList.remove('active');

        if (view === 'map') {
            mapView.style.display = 'block';
            btnMap.classList.add('active');
            // Initialize map on first view (Leaflet needs visible container)
            setTimeout(() => {
                initMap();
                if (map) map.invalidateSize();
            }, 100);
        } else if (view === 'calendar') {
            calendarView.style.display = 'block';
            btnCalendar.classList.add('active');
            // Initialize month view if showing month subview
            if (monthSubview.style.display !== 'none') {
                updateMonthView();
            }
        } else if (view === 'cards') {
            cardsView.style.display = 'block';
            btnCards.classList.add('active');
        } else if (view === 'table') {
            tableView.style.display = 'block';
            btnTable.classList.add('active');
        }
    }

    // Calendar sub-toggle handlers
    const calendarSubBtns = document.querySelectorAll('.calendar-sub-toggle .sub-btn');
    calendarSubBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            calendarSubBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');

            const subview = this.dataset.subview;
            if (subview === 'year') {
                yearSubview.style.display = 'block';
                monthSubview.style.display = 'none';
            } else {
                yearSubview.style.display = 'none';
                monthSubview.style.display = 'block';
                updateMonthView();
            }
        });
    });

    btnMap.addEventListener('click', () => setActiveView('map'));
    btnCalendar.addEventListener('click', () => setActiveView('calendar'));
    btnCards.addEventListener('click', () => setActiveView('cards'));
    btnTable.addEventListener('click', () => setActiveView('table'));

    // Initialize map on page load (Map is default view)
    setTimeout(() => {
        initMap();
        if (map) map.invalidateSize();
    }, 100);

    // Handle URL hash for direct navigation (e.g., #map, #calendar, #cards, #table)
    const hash = window.location.hash.substring(1);
    if (hash === 'calendar' || hash === 'cards' || hash === 'table') {
        setActiveView(hash);
    }

    // Month navigation with year support
    document.getElementById('prev-month').addEventListener('click', function() {
        currentMonthIndex--;
        if (currentMonthIndex < 0) {
            currentMonthIndex = 11;
            currentYear--;
        }
        updateMonthView();
    });

    document.getElementById('next-month').addEventListener('click', function() {
        currentMonthIndex++;
        if (currentMonthIndex > 11) {
            currentMonthIndex = 0;
            currentYear++;
        }
        updateMonthView();
    });

    // Dropdown jump handlers
    if (monthSelect) {
        monthSelect.addEventListener('change', function() {
            currentMonthIndex = parseInt(this.value);
            updateMonthView();
        });
    }

    if (yearSelect) {
        yearSelect.addEventListener('change', function() {
            currentYear = parseInt(this.value);
            updateMonthView();
        });
    }

    // Interactive legend filtering for map
    const mapLegend = document.getElementById('map-legend');
    let activeFilters = new Set();
    let allMapData = [];

    if (mapLegend) {
        // Initialize with all filters active
        mapLegend.querySelectorAll('.legend-item').forEach(item => {
            activeFilters.add(item.dataset.filter);
        });

        // Store original map data
        const mapDataEl = document.getElementById('map-data');
        if (mapDataEl) {
            try {
                allMapData = JSON.parse(mapDataEl.textContent);
            } catch (e) {}
        }

        mapLegend.addEventListener('click', function(e) {
            const item = e.target.closest('.legend-item');
            if (!item) return;

            const filter = item.dataset.filter;
            item.classList.toggle('active');

            if (activeFilters.has(filter)) {
                activeFilters.delete(filter);
            } else {
                activeFilters.add(filter);
            }

            // Rebuild markers with filtered data
            if (markers && map) {
                markers.clearLayers();
                allMapData.forEach(item => {
                    const itemFilter = item.category === 'Meetups' ? 'Meetups' :
                                       item.category === 'Research Labs' ? 'Research Labs' :
                                       item.subcategory;
                    if (!activeFilters.has(itemFilter)) return;

                    const color = getMarkerColor(item);
                    const icon = createCustomIcon(color);
                    const marker = L.marker([item.lat, item.lng], { icon: icon });

                    const dateDisplay = item.start_date
                        ? formatDateRange(item.start_date, item.end_date)
                        : item.dates;

                    let popupContent = `
                        <div class="map-popup">
                            <strong class="popup-title">
                                <a href="${item.url}" target="_blank" rel="noopener">${item.name}</a>
                            </strong>
                            ${item.description ? `<p class="popup-desc">${item.description}</p>` : ''}
                            <div class="popup-meta">
                                <span>üìç ${item.location}</span>
                                ${dateDisplay ? `<span>üìÖ ${dateDisplay}</span>` : ''}
                                ${item.attendees ? `<span>üë• ${item.attendees} attendees</span>` : ''}
                            </div>
                            <div class="popup-footer">
                                <span class="popup-badge" style="background-color: ${color}; color: white;">
                                    ${item.subcategory || item.category}
                                </span>
                                <a href="${item.url}" target="_blank" rel="noopener" class="popup-link">Visit Website ‚Üí</a>
                            </div>
                        </div>
                    `;
                    marker.bindPopup(popupContent, { maxWidth: 300 });
                    markers.addLayer(marker);
                });
            }
        });
    }

    // Category dropdown filter
    const categoryDropdown = document.getElementById('map-category-filter');
    if (categoryDropdown && mapLegend) {
        categoryDropdown.addEventListener('change', function() {
            const selected = this.value;

            if (selected === 'all') {
                // Activate all filters
                activeFilters.clear();
                mapLegend.querySelectorAll('.legend-item').forEach(item => {
                    item.classList.add('active');
                    activeFilters.add(item.dataset.filter);
                });
            } else {
                // Activate only the selected filter
                activeFilters.clear();
                activeFilters.add(selected);
                mapLegend.querySelectorAll('.legend-item').forEach(item => {
                    if (item.dataset.filter === selected) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
            }

            // Rebuild markers with filtered data
            if (markers && map) {
                markers.clearLayers();
                allMapData.forEach(item => {
                    const itemFilter = item.category === 'Meetups' ? 'Meetups' :
                                       item.category === 'Research Labs' ? 'Research Labs' :
                                       item.subcategory;
                    if (!activeFilters.has(itemFilter)) return;

                    const color = getMarkerColor(item);
                    const icon = createCustomIcon(color);
                    const marker = L.marker([item.lat, item.lng], { icon: icon });

                    const dateDisplay = item.start_date
                        ? formatDateRange(item.start_date, item.end_date)
                        : item.dates;

                    let popupContent = `
                        <div class="map-popup">
                            <strong class="popup-title">
                                <a href="${item.url}" target="_blank" rel="noopener">${item.name}</a>
                            </strong>
                            ${item.description ? `<p class="popup-desc">${item.description}</p>` : ''}
                            <div class="popup-meta">
                                <span>üìç ${item.location}</span>
                                ${dateDisplay ? `<span>üìÖ ${dateDisplay}</span>` : ''}
                                ${item.attendees ? `<span>üë• ${item.attendees} attendees</span>` : ''}
                            </div>
                            <div class="popup-footer">
                                <span class="popup-badge" style="background-color: ${color}; color: white;">
                                    ${item.subcategory || item.category}
                                </span>
                                <a href="${item.url}" target="_blank" rel="noopener" class="popup-link">Visit Website ‚Üí</a>
                            </div>
                        </div>
                    `;
                    marker.bindPopup(popupContent, { maxWidth: 300 });
                    markers.addLayer(marker);
                });
            }
        });
    }
});
</script>
{{ end }}
