{{ define "main" }}
{{ $conferences := where .Site.Data.community "category" "Conferences" }}
{{ $researchLabs := where .Site.Data.community "category" "Research Labs" }}
{{ $online := where .Site.Data.community "category" "Online" }}
{{ $meetups := where .Site.Data.community "category" "Meetups" }}
<!-- Hero Section -->
<header class="hero hero-with-image hero-community">
    <h1 class="hero-title">Community & Events</h1>
    <p class="hero-tagline">{{ len $conferences }} conferences ‚Ä¢ {{ len $researchLabs }} research labs ‚Ä¢ {{ len $online }} online communities ‚Ä¢ {{ len $meetups }} meetups</p>
</header>

<!-- Search Index Data for Fuse.js -->
<script id="search-data" type="application/json">
[{{ range $i, $item := .Site.Data.community }}{{ if $i }},{{ end }}{"name":"{{ .name }}","description":"{{ .description | htmlEscape }}","category":"{{ .category }}","location":"{{ .location | htmlEscape }}","dates":"{{ .dates }}","type":"{{ .type }}"}{{ end }}]
</script>

<div class="container">
    <!-- Search and Filters Row -->
    <div class="search-filters-row">
        <!-- Search Bar -->
        <div class="search-container">
            <div class="search-input-wrapper">
                <svg class="search-icon" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <input type="text"
                       id="community-search"
                       class="search-input"
                       placeholder="Search events and communities..."
                       autocomplete="off">
                <button id="clear-search" class="clear-btn" type="button" aria-label="Clear search">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Category Dropdown -->
        {{ $categoryOrder := slice "Conferences" "Research Labs" "Online" "Meetups" }}
        <select id="category-select" class="category-select">
            <option value="all">All Categories</option>
            {{ range $cat := $categoryOrder }}
            <option value="{{ $cat }}">{{ $cat }}</option>
            {{ end }}
        </select>

        <!-- View Toggle -->
        <div class="view-toggle">
            <button id="btn-year" class="toggle-btn active">Year</button>
            <button id="btn-month" class="toggle-btn">Month</button>
            <button id="btn-cards" class="toggle-btn">Cards</button>
        </div>
    </div>

    <div id="result-count" class="result-count">{{ len .Site.Data.community }} events & communities</div>

    <!-- Year View (default) -->
    <div id="year-view">
        <!-- Subcategory Legend -->
        <div class="subcategory-legend">
            <div class="legend-item"><span class="legend-color experimentation"></span> Experimentation</div>
            <div class="legend-item"><span class="legend-color marketing-science"></span> Marketing</div>
            <div class="legend-item"><span class="legend-color pricing-revenue"></span> Pricing</div>
            <div class="legend-item"><span class="legend-color platforms-e-commerce"></span> Platforms</div>
            <div class="legend-item"><span class="legend-color statistics-analytics"></span> Statistics</div>
            <div class="legend-item"><span class="legend-color healthcare-economics"></span> Healthcare</div>
            <div class="legend-item"><span class="legend-color labor-finance"></span> Labor & Finance</div>
            <div class="legend-item"><span class="legend-color antitrust"></span> Antitrust</div>
            <div class="legend-item"><span class="legend-color market-design"></span> Market Design</div>
        </div>

        <div class="calendar-grid">
            {{ $months := slice "January" "February" "March" "April" "May" "June" "July" "August" "September" "October" "November" "December" }}
            {{ range $month := $months }}
            <div class="month-box">
                <div class="month-header">{{ $month }}</div>
                <div class="month-events">
                    {{ $hasEvents := false }}
                    {{ range $.Site.Data.community }}
                    {{ if and (ne .dates "Ongoing") (eq .category "Conferences") }}
                    {{ if or (findRE (printf "^%s" $month) .dates) (findRE (printf "-%s" $month) .dates) }}
                    {{ $hasEvents = true }}
                    {{ $subcatClass := .subcategory | default "" | urlize }}
                    <div class="month-event event-{{ $subcatClass }}" data-month="{{ $month }}">
                        <a href="{{ .url }}" target="_blank" rel="noopener">{{ .name }}</a>
                        <div class="event-tooltip">
                            <div class="tooltip-title">{{ .name }}</div>
                            <div class="tooltip-meta">
                                <span>üìç {{ .location }}</span>
                                <span>üìÖ {{ .dates }}</span>
                                {{ if .attendees }}<span>üë• {{ .attendees }}</span>{{ end }}
                            </div>
                            {{ if .subcategory }}<span class="tooltip-badge">{{ .subcategory }}</span>{{ end }}
                        </div>
                    </div>
                    {{ end }}
                    {{ end }}
                    {{ end }}
                    {{ if not $hasEvents }}
                    <span class="month-empty">No events</span>
                    {{ end }}
                </div>
            </div>
            {{ end }}
        </div>

        <!-- Research Labs (always cards) -->
        <div class="always-available">
            <h3>Research Labs</h3>
            <div class="cards-row">
                {{ range .Site.Data.community }}
                {{ if eq .category "Research Labs" }}
                <div class="resource-card"
                     data-name="{{ .name | lower }}"
                     data-description="{{ .description | lower }}"
                     data-category="{{ .category }}">
                    <div class="card-header">
                        <img class="resource-favicon"
                             src="https://www.google.com/s2/favicons?domain={{ .url | replaceRE "^https?://([^/]+).*" "$1" }}&sz=32"
                             alt=""
                             loading="lazy"
                             onerror="this.style.display='none'">
                        <h3 class="resource-name">
                            <a href="{{ .url }}" target="_blank" rel="noopener">{{ .name }}</a>
                        </h3>
                        <span class="resource-type">{{ .type }}</span>
                    </div>
                    <p class="resource-desc">{{ .description }}</p>
                    <div class="card-footer">
                        <span class="category-badge">{{ .category }}</span>
                        <a href="{{ .url }}" target="_blank" class="link-btn">Visit</a>
                    </div>
                </div>
                {{ end }}
                {{ end }}
            </div>
        </div>

        <!-- Online Communities (always cards) -->
        <div class="always-available">
            <h3>Online Communities</h3>
            <div class="cards-row">
                {{ range .Site.Data.community }}
                {{ if eq .category "Online" }}
                <div class="resource-card"
                     data-name="{{ .name | lower }}"
                     data-description="{{ .description | lower }}"
                     data-category="{{ .category }}">
                    <div class="card-header">
                        <img class="resource-favicon"
                             src="https://www.google.com/s2/favicons?domain={{ .url | replaceRE "^https?://([^/]+).*" "$1" }}&sz=32"
                             alt=""
                             loading="lazy"
                             onerror="this.style.display='none'">
                        <h3 class="resource-name">
                            <a href="{{ .url }}" target="_blank" rel="noopener">{{ .name }}</a>
                        </h3>
                        <span class="resource-type">{{ .type }}</span>
                    </div>
                    <p class="resource-desc">{{ .description }}</p>
                    <div class="card-footer">
                        <span class="category-badge">{{ .category }}</span>
                        <a href="{{ .url }}" target="_blank" class="link-btn">Visit</a>
                    </div>
                </div>
                {{ end }}
                {{ end }}
            </div>
        </div>

        <!-- Meetups (always cards, grouped by city) -->
        <div class="always-available">
            <h3>Meetups</h3>
            <div class="cards-row">
                {{ range .Site.Data.community }}
                {{ if eq .category "Meetups" }}
                <div class="resource-card"
                     data-name="{{ .name | lower }}"
                     data-description="{{ .description | lower }}"
                     data-category="{{ .category }}"
                     data-location="{{ .location | lower }}">
                    <div class="card-header">
                        <img class="resource-favicon"
                             src="https://www.google.com/s2/favicons?domain={{ .url | replaceRE "^https?://([^/]+).*" "$1" }}&sz=32"
                             alt=""
                             loading="lazy"
                             onerror="this.style.display='none'">
                        <h3 class="resource-name">
                            <a href="{{ .url }}" target="_blank" rel="noopener">{{ .name }}</a>
                        </h3>
                        <span class="resource-type">{{ .type }}</span>
                    </div>
                    <p class="resource-desc">{{ .description }}</p>
                    <div class="resource-meta">
                        <span class="meta-item">
                            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                            {{ .location }}
                        </span>
                    </div>
                    <div class="card-footer">
                        <span class="category-badge">{{ .type }}</span>
                        <a href="{{ .url }}" target="_blank" class="link-btn">Visit</a>
                    </div>
                </div>
                {{ end }}
                {{ end }}
            </div>
        </div>
    </div>

    <!-- Month View (hidden by default) -->
    <div id="month-view" style="display: none;">
        <div class="month-nav">
            <button id="prev-month" aria-label="Previous month">‚Üê</button>
            <h2 id="current-month-title">January</h2>
            <button id="next-month" aria-label="Next month">‚Üí</button>
        </div>
        <div id="month-events-container" class="cards-row">
            <!-- Events for selected month will be shown here -->
        </div>
        <p id="no-month-events" class="no-events" style="display: none;">No conferences scheduled for this month.</p>
    </div>

    <!-- Cards View (hidden by default) -->
    <div id="cards-view" style="display: none;">
        <div class="resources-grid">
            {{ range $cat := $categoryOrder }}
            <div class="category-section" data-section-category="{{ $cat }}">
                <h2 class="category-title">{{ $cat }}</h2>
                <div class="cards-row">
                    {{ range $.Site.Data.community }}
                    {{ if eq .category $cat }}
                    <div class="resource-card" data-aos="fade-up"
                         data-name="{{ .name | lower }}"
                         data-description="{{ .description | lower }}"
                         data-category="{{ .category }}"
                         data-location="{{ .location | lower }}"
                         data-dates="{{ .dates | lower }}"
                         data-subcategory="{{ .subcategory | default "" | lower }}">
                        <div class="card-header">
                            <img class="resource-favicon"
                                 src="https://www.google.com/s2/favicons?domain={{ .url | replaceRE "^https?://([^/]+).*" "$1" }}&sz=32"
                                 alt=""
                                 loading="lazy"
                                 onerror="this.style.display='none'">
                            <h3 class="resource-name">
                                <a href="{{ .url }}" target="_blank" rel="noopener">{{ .name }}</a>
                            </h3>
                            <span class="resource-type">{{ .type }}</span>
                        </div>
                        {{ if .best_for }}<p class="resource-best-for">Best for: {{ .best_for }}</p>{{ end }}
                        <p class="resource-desc">{{ .description }}</p>
                        <div class="resource-meta">
                            <span class="meta-item">
                                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                    <circle cx="12" cy="10" r="3"></circle>
                                </svg>
                                {{ .location }}
                            </span>
                            <span class="meta-item">
                                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                                {{ .dates }}
                            </span>
                            {{ if .attendees }}
                            <span class="meta-item attendees-badge">
                                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                </svg>
                                {{ .attendees }}
                            </span>
                            {{ end }}
                        </div>
                        <div class="card-footer">
                            {{ if .subcategory }}<span class="subcategory-badge">{{ .subcategory }}</span>{{ else }}<span class="category-badge">{{ .category }}</span>{{ end }}
                            <a href="{{ .url }}" target="_blank" class="link-btn">Visit</a>
                        </div>
                    </div>
                    {{ end }}
                    {{ end }}
                </div>
            </div>
            {{ end }}
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>Community resources for tech economists</p>
    </footer>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize PageSearch with Fuse.js
    new PageSearch({
        searchInputId: 'community-search',
        cardSelector: '#cards-view .resource-card',
        sectionSelector: '#cards-view .category-section',
        itemLabel: 'events & communities',
        fuseKeys: [
            { name: 'name', weight: 2 },
            { name: 'description', weight: 1 },
            { name: 'location', weight: 0.8 },
            { name: 'dates', weight: 0.5 },
            { name: 'category', weight: 0.5 }
        ]
    });

    // View elements
    const yearView = document.getElementById('year-view');
    const monthView = document.getElementById('month-view');
    const cardsView = document.getElementById('cards-view');
    const btnYear = document.getElementById('btn-year');
    const btnMonth = document.getElementById('btn-month');
    const btnCards = document.getElementById('btn-cards');

    // Month navigation
    const months = ['January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'];
    let currentMonthIndex = new Date().getMonth();
    const monthTitle = document.getElementById('current-month-title');
    const monthEventsContainer = document.getElementById('month-events-container');
    const noEventsMsg = document.getElementById('no-month-events');

    // Get all conference data from year view
    function getConferencesForMonth(monthName) {
        const events = document.querySelectorAll('#year-view .month-event[data-month="' + monthName + '"]');
        return Array.from(events);
    }

    // Update month view with conferences
    function updateMonthView() {
        const monthName = months[currentMonthIndex];
        monthTitle.textContent = monthName;
        monthEventsContainer.innerHTML = '';

        const events = getConferencesForMonth(monthName);

        if (events.length === 0) {
            noEventsMsg.style.display = 'block';
            monthEventsContainer.style.display = 'none';
        } else {
            noEventsMsg.style.display = 'none';
            monthEventsContainer.style.display = 'grid';

            events.forEach(event => {
                const link = event.querySelector('a');
                const tooltip = event.querySelector('.event-tooltip');
                const subcatClass = Array.from(event.classList).find(c => c.startsWith('event-') && c !== 'event-tooltip');

                const card = document.createElement('div');
                card.className = 'resource-card month-detail-card';

                // Extract tooltip data
                const title = tooltip ? tooltip.querySelector('.tooltip-title').textContent : link.textContent;
                const metaSpans = tooltip ? tooltip.querySelectorAll('.tooltip-meta span') : [];
                const badge = tooltip ? tooltip.querySelector('.tooltip-badge') : null;

                let metaHtml = '';
                metaSpans.forEach(span => {
                    metaHtml += '<span class="meta-item">' + span.textContent + '</span>';
                });

                card.innerHTML = `
                    <div class="card-header">
                        <h3 class="resource-name">
                            <a href="${link.href}" target="_blank" rel="noopener">${title}</a>
                        </h3>
                    </div>
                    <div class="resource-meta">${metaHtml}</div>
                    <div class="card-footer">
                        ${badge ? '<span class="subcategory-badge">' + badge.textContent + '</span>' : ''}
                        <a href="${link.href}" target="_blank" class="link-btn">Visit</a>
                    </div>
                `;

                monthEventsContainer.appendChild(card);
            });
        }
    }

    // View toggle handlers
    function setActiveView(view) {
        yearView.style.display = 'none';
        monthView.style.display = 'none';
        cardsView.style.display = 'none';
        btnYear.classList.remove('active');
        btnMonth.classList.remove('active');
        btnCards.classList.remove('active');

        if (view === 'year') {
            yearView.style.display = 'block';
            btnYear.classList.add('active');
        } else if (view === 'month') {
            monthView.style.display = 'block';
            btnMonth.classList.add('active');
            updateMonthView();
        } else {
            cardsView.style.display = 'block';
            btnCards.classList.add('active');
        }
    }

    btnYear.addEventListener('click', () => setActiveView('year'));
    btnMonth.addEventListener('click', () => setActiveView('month'));
    btnCards.addEventListener('click', () => setActiveView('cards'));

    // Month navigation
    document.getElementById('prev-month').addEventListener('click', function() {
        currentMonthIndex = (currentMonthIndex - 1 + 12) % 12;
        updateMonthView();
    });

    document.getElementById('next-month').addEventListener('click', function() {
        currentMonthIndex = (currentMonthIndex + 1) % 12;
        updateMonthView();
    });
});
</script>
{{ end }}
