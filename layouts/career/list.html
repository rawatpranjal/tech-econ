{{ define "main" }}
<!-- Hero Section -->
<header class="hero hero-with-image hero-career">
    <h1 class="hero-title">Career</h1>
    {{ $activeCount := 0 }}
    {{ range .Site.Data.career }}{{ if .tab }}{{ $activeCount = add $activeCount 1 }}{{ end }}{{ end }}
    <p class="hero-tagline">{{ $activeCount }} curated resources for your PhD to Tech journey.</p>
</header>

<div class="container">
    <!-- Search Bar -->
    <div class="search-filters-row">
        <div class="search-container">
            <div class="search-input-wrapper">
                <svg class="search-icon" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <input type="text" id="career-search" class="search-input" placeholder="Search career resources..." autocomplete="off">
                <button id="clear-search" class="clear-btn" type="button" aria-label="Clear search">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Tabs -->
    <div class="career-tabs">
        <button class="career-tab active" data-tab="start-here">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                <path d="M2 17l10 5 10-5"></path>
                <path d="M2 12l10 5 10-5"></path>
            </svg>
            Start Here
        </button>
        <button class="career-tab" data-tab="understand">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            Understand
        </button>
        <button class="career-tab" data-tab="find-jobs">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            Find Jobs
        </button>
        <button class="career-tab" data-tab="interview">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <circle cx="12" cy="12" r="6"></circle>
                <circle cx="12" cy="12" r="2"></circle>
            </svg>
            Interview Prep
        </button>
        <button class="career-tab" data-tab="offers">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="1" x2="12" y2="23"></line>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
            Offers
        </button>
    </div>

    <!-- Tab 1: Start Here -->
    <div id="tab-start-here" class="career-tab-content active">
        <section class="curated-section essential-section">
            <div class="section-header">
                <h2>Essential Reading</h2>
                <p>New to tech careers for economists? Begin with these foundational resources.</p>
            </div>
            <ol class="essential-list">
                {{ $num := 0 }}
                {{ range .Site.Data.career }}
                {{ if eq .tab "start-here" }}
                {{ $num = add $num 1 }}
                <li class="essential-item">
                    <span class="essential-number">{{ $num }}</span>
                    <div class="essential-content">
                        <div class="essential-header">
                            <img class="favicon" src="https://www.google.com/s2/favicons?domain={{ .url | replaceRE "^https?://([^/]+).*" "$1" }}&sz=32" alt="" loading="lazy" onerror="this.style.display='none'">
                            <a href="{{ .url }}" target="_blank" rel="noopener" class="essential-name">{{ .name }}</a>
                            <span class="type-badge">{{ .type }}</span>
                        </div>
                        <p class="essential-desc">{{ .description }}</p>
                    </div>
                </li>
                {{ end }}
                {{ end }}
            </ol>
        </section>
    </div>

    <!-- Tab 2: Understand -->
    <div id="tab-understand" class="career-tab-content">
        <!-- Subtabs -->
        <div class="subtabs">
            <button class="subtab active" data-subtab="role-types">Role Types</button>
            <button class="subtab" data-subtab="what-teams-do">What Teams Do</button>
            <button class="subtab" data-subtab="role-models">Leading Lights</button>
        </div>

        <!-- Role Types Subtab -->
        <div id="subtab-role-types" class="subtab-content active">
            <section class="curated-section roles-section">
                <div class="section-header">
                    <h2>Understanding Roles</h2>
                    <p>Learn how DS/Economist roles differ across companies and levels.</p>
                </div>
                <div class="roles-grid">
                    {{ range .Site.Data.career }}
                    {{ if and (eq .tab "understand") (eq .subtab "role-types") }}
                    <a href="{{ .url }}" target="_blank" rel="noopener" class="role-card">
                        <img class="favicon" src="https://www.google.com/s2/favicons?domain={{ .url | replaceRE "^https?://([^/]+).*" "$1" }}&sz=32" alt="" loading="lazy" onerror="this.style.display='none'">
                        <div class="role-info">
                            <span class="role-name">{{ .name }}</span>
                            <p class="role-desc">{{ .description | truncate 100 }}</p>
                        </div>
                    </a>
                    {{ end }}
                    {{ end }}
                </div>
            </section>
        </div>

        <!-- What Teams Do Subtab -->
        <div id="subtab-what-teams-do" class="subtab-content">
            <section class="curated-section work-section">
                <div class="section-header">
                    <h2>What Teams Do</h2>
                    <p>One exemplar article per domain to understand different team types.</p>
                </div>
                <div class="work-grid">
                    {{ $domains := slice "Pricing" "Experimentation" "Ads" "Trust" "Forecasting" "Recommendations" "Growth" "Economist Teams" }}
                    {{ range $domain := $domains }}
                    {{ range $.Site.Data.career }}
                    {{ if and (eq .tab "understand") (eq .subtab "what-teams-do") (eq .domain $domain) }}
                    <a href="{{ .url }}" target="_blank" rel="noopener" class="work-card">
                        <div class="work-badge">{{ $domain }}</div>
                        <div class="work-content">
                            <img class="favicon" src="https://www.google.com/s2/favicons?domain={{ .url | replaceRE "^https?://([^/]+).*" "$1" }}&sz=32" alt="" loading="lazy" onerror="this.style.display='none'">
                            <span class="work-name">{{ .name }}</span>
                        </div>
                        <p class="work-desc">{{ .description }}</p>
                    </a>
                    {{ end }}
                    {{ end }}
                    {{ end }}
                </div>
            </section>
        </div>

        <!-- Leading Lights Subtab -->
        <div id="subtab-role-models" class="subtab-content">
            <section class="curated-section role-models-section">
                <div class="section-header">
                    <h2>Leading Lights</h2>
                    <p>{{ len .Site.Data.leading_lights }} pioneers who forged the path for tech economics.</p>
                </div>
                <div class="role-models-grid">
                    {{ range .Site.Data.leading_lights }}
                    <a href="{{ "leading-lights/" | relURL }}{{ .slug }}/" class="role-model-card">
                        <div class="role-model-image-wrapper">
                            <img data-src="{{ .image }}" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'%3E%3Crect fill='%231e293b' width='120' height='120'/%3E%3C/svg%3E" alt="{{ .name }}" class="role-model-image lazy-profile" onerror="this.src='https://ui-avatars.com/api/?name={{ .name | urlize }}&size=200&background=1e293b&color=fff'">
                        </div>
                        <div class="role-model-info">
                            <span class="role-model-name">{{ .name }}</span>
                            <span class="role-model-title">{{ .title }}</span>
                            <span class="role-model-company">{{ .company }}</span>
                        </div>
                    </a>
                    {{ end }}
                </div>
            </section>
        </div>

    </div>

    <!-- Tab 3: Find Jobs -->
    <div id="tab-find-jobs" class="career-tab-content">
        <!-- Subtabs -->
        <div class="subtabs">
            <button class="subtab active" data-subtab="companies">Companies by Sector</button>
            <button class="subtab" data-subtab="job-boards">Job Boards</button>
            <button class="subtab" data-subtab="networking">Networking</button>
            <button class="subtab" data-subtab="materials">Materials</button>
        </div>

        <!-- Companies Subtab -->
        <div id="subtab-companies" class="subtab-content active">
            <section class="curated-section companies-section">
                <div class="section-header">
                    <h2>Companies Hiring</h2>
                    <p>Career portals for tech companies hiring economists and data scientists.</p>
                </div>

                <!-- Sector Pills -->
                <div class="sector-pills">
                    <button class="sector-pill active" data-sector="all">All</button>
                    <button class="sector-pill" data-sector="faang">FAANG+</button>
                    <button class="sector-pill" data-sector="marketplace">Marketplaces</button>
                    <button class="sector-pill" data-sector="social">Social & Media</button>
                    <button class="sector-pill" data-sector="fintech">Fintech</button>
                    <button class="sector-pill" data-sector="saas">Enterprise</button>
                    <button class="sector-pill" data-sector="pharma">Pharma</button>
                    <button class="sector-pill" data-sector="ai">AI</button>
                    <button class="sector-pill" data-sector="hardware">Hardware</button>
                    <button class="sector-pill" data-sector="gaming">Gaming</button>
                    <button class="sector-pill" data-sector="travel">Travel</button>
                    <button class="sector-pill" data-sector="retail">Retail</button>
                </div>

                <!-- Sector Descriptions -->
                <div class="sector-description" id="sector-desc-faang" style="display: none;">
                    <p>Big tech with mature data orgs, large-scale experimentation, and ML infrastructure.</p>
                </div>
                <div class="sector-description" id="sector-desc-marketplace" style="display: none;">
                    <p>Two-sided platforms with rich matching, pricing, and marketplace dynamics problems.</p>
                </div>
                <div class="sector-description" id="sector-desc-social" style="display: none;">
                    <p>Content platforms with recommendation systems, feed ranking, and A/B testing at scale.</p>
                </div>
                <div class="sector-description" id="sector-desc-fintech" style="display: none;">
                    <p>Financial services with credit modeling, fraud detection, and risk analytics.</p>
                </div>
                <div class="sector-description" id="sector-desc-saas" style="display: none;">
                    <p>B2B software with churn prediction, usage analytics, and product-led growth.</p>
                </div>
                <div class="sector-description" id="sector-desc-pharma" style="display: none;">
                    <p>Healthcare with clinical trials, real-world evidence, and patient outcome modeling.</p>
                </div>
                <div class="sector-description" id="sector-desc-ai" style="display: none;">
                    <p>Emerging space with foundation models, RLHF, and novel evaluation challenges.</p>
                </div>
                <div class="sector-description" id="sector-desc-hardware" style="display: none;">
                    <p>Hardware companies building data teams for supply chain, demand sensing, and product analytics.</p>
                </div>
                <div class="sector-description" id="sector-desc-gaming" style="display: none;">
                    <p>Virtual economies with player behavior modeling, live ops, and in-game monetization.</p>
                </div>
                <div class="sector-description" id="sector-desc-travel" style="display: none;">
                    <p>Travel platforms with dynamic pricing, demand forecasting, and inventory optimization.</p>
                </div>
                <div class="sector-description" id="sector-desc-retail" style="display: none;">
                    <p>Retail with price optimization, inventory management, and customer analytics.</p>
                </div>

                <!-- Vertical Pills (populated dynamically based on selected sector) -->
                <div id="vertical-pills-container" class="vertical-pills-container" style="display: none;">
                    <span class="vertical-label">Filter by:</span>
                    <div id="vertical-pills" class="vertical-pills"></div>
                </div>

                <!-- Verticals Data -->
                <script id="verticals-data" type="application/json">
                {{ $.Site.Data.verticals | jsonify }}
                </script>

                <!-- Company Search -->
                <div class="company-search-container">
                    <input type="text" id="company-search" class="company-search-input" placeholder="Search companies...">
                </div>

                <!-- Additional Filters Row -->
                <div class="filter-row">
                    <div class="filter-group">
                        <span class="filter-label">Region:</span>
                        <div class="region-pills">
                            <button class="region-pill active" data-region="all">All</button>
                            <button class="region-pill" data-region="us">US</button>
                            <button class="region-pill" data-region="europe">Europe</button>
                            <button class="region-pill" data-region="asia">Asia</button>
                            <button class="region-pill" data-region="latam">LatAm</button>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label class="economist-toggle">
                            <input type="checkbox" id="economist-filter">
                            <span class="toggle-label">Economist Friendly (historically hired for Economist skills)</span>
                        </label>
                    </div>
                </div>

                <div class="companies-grid">
                    {{ range .Site.Data.career }}
                    {{ if and (eq .tab "find-jobs") (eq .subtab "companies") }}
                    {{ $region := "us" }}
                    {{ $isEconomist := false }}
                    {{ range .tags }}
                        {{ if eq . "Europe" }}{{ $region = "europe" }}{{ end }}
                        {{ if eq . "Asia" }}{{ $region = "asia" }}{{ end }}
                        {{ if eq . "LatAm" }}{{ $region = "latam" }}{{ end }}
                        {{ if eq . "economist-title" }}{{ $isEconomist = true }}{{ end }}
                    {{ end }}
                    <a href="{{ .url }}" target="_blank" rel="noopener" class="company-card" data-sector="{{ .sector }}" data-vertical="{{ .vertical | default "" }}" data-region="{{ $region }}" data-economist="{{ $isEconomist }}" data-name="{{ .name | lower }}">
                        <img class="favicon" src="https://www.google.com/s2/favicons?domain={{ .url | replaceRE "^https?://([^/]+).*" "$1" }}&sz=32" alt="" loading="lazy" onerror="this.style.display='none'">
                        <span class="company-name">{{ .name }}</span>
                        {{ if $isEconomist }}<span class="economist-badge" title="Verified economist job titles">ðŸŽ“</span>{{ end }}
                    </a>
                    {{ end }}
                    {{ end }}
                </div>
            </section>
        </div>

        <!-- Job Boards Subtab -->
        <div id="subtab-job-boards" class="subtab-content">
            <section class="curated-section">
                <div class="section-header">
                    <h2>Job Boards</h2>
                    <p>Specialized job boards for economists and data scientists.</p>
                </div>
                <div class="resource-grid">
                    {{ range .Site.Data.career }}
                    {{ if and (eq .tab "find-jobs") (eq .subtab "job-boards") }}
                    <a href="{{ .url }}" target="_blank" rel="noopener" class="resource-card">
                        <img class="favicon" src="https://www.google.com/s2/favicons?domain={{ .url | replaceRE "^https?://([^/]+).*" "$1" }}&sz=32" alt="" loading="lazy" onerror="this.style.display='none'">
                        <div class="resource-content">
                            <span class="resource-name">{{ .name }}</span>
                            <p class="resource-desc">{{ .description }}</p>
                        </div>
                        <span class="type-badge">{{ .type }}</span>
                    </a>
                    {{ end }}
                    {{ end }}
                </div>
            </section>
        </div>

        <!-- Networking Subtab -->
        <div id="subtab-networking" class="subtab-content">
            <section class="curated-section">
                <div class="section-header">
                    <h2>Networking</h2>
                    <p>Conferences, communities, and fellowships to build connections.</p>
                </div>
                <div class="resource-grid">
                    {{ range .Site.Data.career }}
                    {{ if and (eq .tab "find-jobs") (eq .subtab "networking") }}
                    <a href="{{ .url }}" target="_blank" rel="noopener" class="resource-card">
                        <img class="favicon" src="https://www.google.com/s2/favicons?domain={{ .url | replaceRE "^https?://([^/]+).*" "$1" }}&sz=32" alt="" loading="lazy" onerror="this.style.display='none'">
                        <div class="resource-content">
                            <span class="resource-name">{{ .name }}</span>
                            <p class="resource-desc">{{ .description }}</p>
                        </div>
                        <span class="type-badge">{{ .type }}</span>
                    </a>
                    {{ end }}
                    {{ end }}
                </div>
            </section>
        </div>

        <!-- Materials Subtab -->
        <div id="subtab-materials" class="subtab-content">
            <section class="curated-section">
                <div class="section-header">
                    <h2>Application Materials</h2>
                    <p>Resumes, portfolios, GitHub profiles, and personal websites.</p>
                </div>
                <div class="resource-grid">
                    {{ range .Site.Data.career }}
                    {{ if and (eq .tab "find-jobs") (eq .subtab "materials") }}
                    <a href="{{ .url }}" target="_blank" rel="noopener" class="resource-card">
                        <img class="favicon" src="https://www.google.com/s2/favicons?domain={{ .url | replaceRE "^https?://([^/]+).*" "$1" }}&sz=32" alt="" loading="lazy" onerror="this.style.display='none'">
                        <div class="resource-content">
                            <span class="resource-name">{{ .name }}</span>
                            <p class="resource-desc">{{ .description }}</p>
                        </div>
                        <span class="type-badge">{{ .type }}</span>
                    </a>
                    {{ end }}
                    {{ end }}
                </div>
            </section>
        </div>
    </div>

    <!-- Tab 4: Interview Prep -->
    <div id="tab-interview" class="career-tab-content">
        <!-- Subtabs -->
        <div class="subtabs">
            <button class="subtab active" data-subtab="experimentation">Experimentation</button>
            <button class="subtab" data-subtab="ml-questions">ML Questions</button>
            <button class="subtab" data-subtab="ml-systems">ML Systems</button>
            <button class="subtab" data-subtab="ml-design">ML Design</button>
            <button class="subtab" data-subtab="ds-interview">DS Interview</button>
            <button class="subtab" data-subtab="sql">SQL</button>
            <button class="subtab" data-subtab="behavioral">Behavioral</button>
            <button class="subtab" data-subtab="product">Product</button>
        </div>

        {{ $interviewSubtabs := slice "experimentation" "ml-questions" "ml-systems" "ml-design" "ds-interview" "sql" "behavioral" "product" }}
        {{ range $subtab := $interviewSubtabs }}
        {{ $subtabCount := 0 }}
        {{ range $.Site.Data.career }}
            {{ if and (eq .tab "interview") (eq .subtab $subtab) (not .archived) }}
                {{ $subtabCount = add $subtabCount 1 }}
            {{ end }}
        {{ end }}

        {{ if gt $subtabCount 0 }}
        <div id="subtab-{{ $subtab }}" class="subtab-content{{ if eq $subtab "experimentation" }} active{{ end }}">
            <section class="curated-section">
                <div class="interview-grid">
                    {{ range $.Site.Data.career }}
                    {{ if and (eq .tab "interview") (eq .subtab $subtab) (not .archived) }}
                    <a href="{{ .url }}" target="_blank" rel="noopener" class="interview-card">
                        <img class="favicon" src="https://www.google.com/s2/favicons?domain={{ .url | replaceRE "^https?://([^/]+).*" "$1" }}&sz=32" alt="" loading="lazy" onerror="this.style.display='none'">
                        <div class="interview-content">
                            <span class="interview-name">{{ .name }}</span>
                            <p class="interview-desc">{{ .description }}</p>
                        </div>
                        <span class="type-badge">{{ .type }}</span>
                    </a>
                    {{ end }}
                    {{ end }}
                </div>
            </section>
        </div>
        {{ end }}
        {{ end }}
    </div>

    <!-- Tab 5: Offers -->
    <div id="tab-offers" class="career-tab-content">
        <!-- Subtabs -->
        <div class="subtabs">
            <button class="subtab active" data-subtab="negotiation">Negotiation</button>
            <button class="subtab" data-subtab="visa">Visa & Immigration</button>
        </div>

        <!-- Negotiation Subtab -->
        <div id="subtab-negotiation" class="subtab-content active">
            <section class="curated-section negotiation-section">
                <div class="section-header">
                    <h2>Offer Negotiation</h2>
                    <p>Resources for evaluating and negotiating tech offers. Can mean $50K-$150K difference in first-year compensation.</p>
                </div>
                <div class="negotiation-grid">
                    {{ range .Site.Data.career }}
                    {{ if and (eq .tab "offers") (eq .subtab "negotiation") }}
                    <a href="{{ .url }}" target="_blank" rel="noopener" class="negotiation-card">
                        <img class="favicon" src="https://www.google.com/s2/favicons?domain={{ .url | replaceRE "^https?://([^/]+).*" "$1" }}&sz=32" alt="" loading="lazy" onerror="this.style.display='none'">
                        <div class="negotiation-content">
                            <span class="negotiation-name">{{ .name }}</span>
                            <p class="negotiation-desc">{{ .description }}</p>
                        </div>
                    </a>
                    {{ end }}
                    {{ end }}
                </div>
            </section>
        </div>

        <!-- Visa Subtab -->
        <div id="subtab-visa" class="subtab-content">
            <section class="curated-section">
                <div class="section-header">
                    <h2>Visa & Immigration</h2>
                    <p>H-1B sponsorship, green cards, and immigration resources for international candidates.</p>
                </div>
                <div class="resource-grid">
                    {{ range .Site.Data.career }}
                    {{ if and (eq .tab "offers") (eq .subtab "visa") }}
                    <a href="{{ .url }}" target="_blank" rel="noopener" class="resource-card">
                        <img class="favicon" src="https://www.google.com/s2/favicons?domain={{ .url | replaceRE "^https?://([^/]+).*" "$1" }}&sz=32" alt="" loading="lazy" onerror="this.style.display='none'">
                        <div class="resource-content">
                            <span class="resource-name">{{ .name }}</span>
                            <p class="resource-desc">{{ .description }}</p>
                        </div>
                        <span class="type-badge">{{ .type }}</span>
                    </a>
                    {{ end }}
                    {{ end }}
                </div>
            </section>
        </div>
    </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Main tab switching
    const tabs = document.querySelectorAll('.career-tab');
    const tabContents = document.querySelectorAll('.career-tab-content');

    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const targetTab = this.dataset.tab;

            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));

            this.classList.add('active');
            document.getElementById('tab-' + targetTab).classList.add('active');
        });
    });

    // Subtab switching
    document.querySelectorAll('.subtabs').forEach(subtabContainer => {
        const subtabs = subtabContainer.querySelectorAll('.subtab');
        const parent = subtabContainer.closest('.career-tab-content');

        subtabs.forEach(subtab => {
            subtab.addEventListener('click', function() {
                const targetSubtab = this.dataset.subtab;

                // Update active subtab button
                subtabs.forEach(s => s.classList.remove('active'));
                this.classList.add('active');

                // Update active subtab content
                parent.querySelectorAll('.subtab-content').forEach(c => c.classList.remove('active'));
                const targetContent = parent.querySelector('#subtab-' + targetSubtab);
                if (targetContent) {
                    targetContent.classList.add('active');
                }
            });
        });
    });

    // Company filtering (sector, vertical, region, economist, search)
    const sectorPills = document.querySelectorAll('.sector-pill');
    const regionPills = document.querySelectorAll('.region-pill');
    const companyCards = document.querySelectorAll('.company-card');
    const sectorDescs = document.querySelectorAll('.sector-description');
    const economistFilter = document.getElementById('economist-filter');
    const companySearch = document.getElementById('company-search');
    const verticalPillsContainer = document.getElementById('vertical-pills-container');
    const verticalPillsEl = document.getElementById('vertical-pills');

    // Load verticals data
    let verticalsData = {};
    try {
        const verticalsEl = document.getElementById('verticals-data');
        if (verticalsEl) {
            verticalsData = JSON.parse(verticalsEl.textContent);
        }
    } catch (e) {
        console.warn('Failed to load verticals data:', e);
    }

    let currentSector = 'all';
    let currentVertical = 'all';
    let currentRegion = 'all';
    let economistOnly = false;
    let searchQuery = '';

    function filterCompanies() {
        companyCards.forEach(card => {
            const matchesSector = currentSector === 'all' || card.dataset.sector === currentSector;
            const matchesVertical = currentVertical === 'all' || card.dataset.vertical === currentVertical;
            const matchesRegion = currentRegion === 'all' || card.dataset.region === currentRegion;
            const matchesEconomist = !economistOnly || card.dataset.economist === 'true';
            const matchesSearch = searchQuery === '' || card.dataset.name.includes(searchQuery);

            if (matchesSector && matchesVertical && matchesRegion && matchesEconomist && matchesSearch) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });

        // Show/hide sector descriptions
        sectorDescs.forEach(desc => {
            desc.style.display = desc.id === 'sector-desc-' + currentSector ? 'block' : 'none';
        });
    }

    function updateVerticalPills() {
        // Clear existing pills
        verticalPillsEl.innerHTML = '';
        currentVertical = 'all';

        // Hide if no sector selected or sector has no verticals
        if (currentSector === 'all' || !verticalsData[currentSector]) {
            verticalPillsContainer.style.display = 'none';
            return;
        }

        const verticals = verticalsData[currentSector];
        const verticalKeys = Object.keys(verticals);

        // Only show if there are verticals for this sector
        if (verticalKeys.length === 0) {
            verticalPillsContainer.style.display = 'none';
            return;
        }

        // Add "All" pill
        const allPill = document.createElement('button');
        allPill.className = 'vertical-pill active';
        allPill.dataset.vertical = 'all';
        allPill.textContent = 'All';
        allPill.addEventListener('click', handleVerticalClick);
        verticalPillsEl.appendChild(allPill);

        // Add pills for each vertical
        verticalKeys.forEach(key => {
            const vertical = verticals[key];
            const pill = document.createElement('button');
            pill.className = 'vertical-pill';
            pill.dataset.vertical = key;
            pill.textContent = vertical.label;
            pill.title = vertical.description || '';
            pill.addEventListener('click', handleVerticalClick);
            verticalPillsEl.appendChild(pill);
        });

        verticalPillsContainer.style.display = 'flex';
    }

    function handleVerticalClick(e) {
        currentVertical = e.target.dataset.vertical;
        document.querySelectorAll('.vertical-pill').forEach(p => p.classList.remove('active'));
        e.target.classList.add('active');
        filterCompanies();
    }

    sectorPills.forEach(pill => {
        pill.addEventListener('click', function() {
            currentSector = this.dataset.sector;
            sectorPills.forEach(p => p.classList.remove('active'));
            this.classList.add('active');
            updateVerticalPills();
            filterCompanies();
        });
    });

    regionPills.forEach(pill => {
        pill.addEventListener('click', function() {
            currentRegion = this.dataset.region;
            regionPills.forEach(p => p.classList.remove('active'));
            this.classList.add('active');
            filterCompanies();
        });
    });

    if (companySearch) {
        companySearch.addEventListener('input', function() {
            searchQuery = this.value.toLowerCase();
            filterCompanies();
        });
    }

    if (economistFilter) {
        economistFilter.addEventListener('change', function() {
            economistOnly = this.checked;
            filterCompanies();
        });
    }

    // Search functionality
    const searchInput = document.getElementById('career-search');
    const clearBtn = document.getElementById('clear-search');

    searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase();

        // Search in all visible cards across all sections
        document.querySelectorAll('.essential-item, .role-card, .work-card, .company-card, .negotiation-card, .interview-card, .reference-card, .resource-card, .role-model-card').forEach(card => {
            const text = card.textContent.toLowerCase();
            if (query === '' || text.includes(query)) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });

        clearBtn.style.display = query ? 'flex' : 'none';
    });

    clearBtn.addEventListener('click', function() {
        searchInput.value = '';
        searchInput.dispatchEvent(new Event('input'));
        this.style.display = 'none';
    });

    // Lazy load Leading Lights profile images
    var profileObserver = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry) {
            if (entry.isIntersecting) {
                var img = entry.target;
                if (img.dataset.src) {
                    img.src = img.dataset.src;
                    img.removeAttribute('data-src');
                }
                profileObserver.unobserve(img);
            }
        });
    }, { rootMargin: '200px' });

    document.querySelectorAll('.lazy-profile').forEach(function(img) {
        profileObserver.observe(img);
    });

});
</script>

<style>
/* Company Search */
.company-search-container {
    margin-bottom: 1rem;
}

.company-search-input {
    width: 100%;
    max-width: 400px;
    padding: 0.6rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--card-bg);
    color: var(--text-color);
    font-size: 0.95rem;
}

.company-search-input:focus {
    outline: none;
    border-color: var(--accent-color);
}

/* Filter Row */
.filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
    align-items: center;
    margin-bottom: 1rem;
    padding: 0.75rem 0;
}

.filter-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.filter-label {
    font-size: 0.85rem;
    color: var(--text-muted);
    font-weight: 500;
}

/* Region Pills */
.region-pills {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
}

.region-pill {
    padding: 0.35rem 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 20px;
    background: var(--card-bg);
    color: var(--text-muted);
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
}

.region-pill:hover {
    border-color: var(--accent-color);
    color: var(--text-color);
}

.region-pill.active {
    background: var(--accent-color);
    border-color: var(--accent-color);
    color: white;
}

/* Economist Toggle */
.economist-toggle {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    font-size: 0.85rem;
    color: var(--text-muted);
}

.economist-toggle input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: var(--accent-color);
}

.toggle-label {
    user-select: none;
}

/* Economist Badge */
.economist-badge {
    font-size: 0.75rem;
    margin-left: 0.25rem;
}

/* Sector Descriptions */
.sector-description {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-left: 3px solid var(--accent-color);
    border-radius: 8px;
    padding: 0.75rem 1rem;
    margin-bottom: 1rem;
    font-size: 0.9rem;
    color: var(--text-muted);
}

.sector-description p {
    margin: 0;
}

/* Leading Lights Grid */
.role-models-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 1.5rem;
}

.role-model-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: 1.25rem;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    text-decoration: none;
    color: inherit;
    transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
}

.role-model-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    border-color: var(--accent-color);
}

.role-model-image-wrapper {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    overflow: hidden;
    margin-bottom: 1rem;
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
}

.role-model-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center top;
}

.role-model-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.role-model-name {
    font-weight: 600;
    font-size: 1rem;
    color: var(--text-primary);
}

.role-model-title {
    font-size: 0.8rem;
    color: var(--accent-color);
}

.role-model-company {
    font-size: 0.8rem;
    color: var(--text-muted);
}

/* Dark mode */
[data-theme="dark"] .role-model-card {
    background: rgba(30, 41, 59, 0.6);
    border-color: rgba(71, 85, 105, 0.5);
}

[data-theme="dark"] .role-model-card:hover {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
}

@media (max-width: 640px) {
    .role-models-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }

    .role-model-image-wrapper {
        width: 80px;
        height: 80px;
    }

    .role-model-name {
        font-size: 0.9rem;
    }
}
</style>
{{ end }}
