{{ define "main" }}
{{ $topicId := .Params.topic_id }}
{{ $topic := index (where .Site.Data.papers.topics "id" $topicId) 0 }}

<!-- Hero Section -->
<header class="hero hero-with-image hero-papers">
    <div class="hero-breadcrumb">
        <a href="{{ "papers/" | relURL }}">Papers</a>
        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 18l6-6-6-6"></path>
        </svg>
    </div>
    <h1 class="hero-title">{{ $topic.name }}</h1>
    {{ $paperCount := 0 }}
    {{ range $topic.subtopics }}
        {{ $paperCount = add $paperCount (len .papers) }}
    {{ end }}
    <p class="hero-tagline">{{ $topic.description }}{{ if gt $paperCount 0 }} &bull; {{ $paperCount }} papers{{ end }}</p>
</header>

<div class="container">
    <!-- View Toggle -->
    <div class="search-filters-row">
        <div class="result-count">{{ len $topic.subtopics }} subtopics</div>
        <div class="view-toggle">
            <button id="btn-cards" class="toggle-btn active">Cards</button>
            <button id="btn-table" class="toggle-btn">Table</button>
        </div>
    </div>

    <!-- Subtopics -->
    <div class="subtopics-container">
        {{ range $topic.subtopics }}
        <section class="subtopic-section" id="{{ .id }}">
            <div class="subtopic-header">
                <h2 class="subtopic-name">{{ .name }}</h2>
                <p class="subtopic-application">{{ .application }}</p>
            </div>

            {{ if .papers }}
            <!-- Cards View -->
            <div class="papers-grid cards-view-content">
                {{ range .papers }}
                <div class="paper-card" data-aos="fade-up">
                    <div class="paper-header">
                        <span class="paper-year">{{ .year }}</span>
                        {{ with .citations }}<span class="paper-citations">{{ . }} cited</span>{{ end }}
                    </div>
                    <h3 class="paper-title">
                        <a href="{{ .url }}" target="_blank" rel="noopener">{{ .title }}</a>
                    </h3>
                    <p class="paper-authors">{{ .authors }}</p>
                    {{ if .description }}
                    <p class="paper-description">{{ .description }}</p>
                    {{ end }}
                </div>
                {{ end }}
            </div>

            <!-- Table View -->
            <div class="papers-table-wrapper table-view-content" style="display: none;">
                <table class="papers-table papers-detail-table">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Authors</th>
                            <th>Year</th>
                            <th>Citations</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{ range .papers }}
                        <tr>
                            <td class="paper-title-cell">
                                <a href="{{ .url }}" target="_blank" rel="noopener">{{ .title }}</a>
                                {{ if .description }}<div class="paper-desc-hint">{{ .description }}</div>{{ end }}
                            </td>
                            <td class="paper-authors-cell">{{ .authors }}</td>
                            <td class="paper-year-cell">{{ .year }}</td>
                            <td class="paper-citations-cell">{{ with .citations }}{{ . }}{{ else }}â€”{{ end }}</td>
                        </tr>
                        {{ end }}
                    </tbody>
                </table>
            </div>
            {{ else }}
            <div class="papers-empty">
                <p>Papers coming soon</p>
            </div>
            {{ end }}
        </section>
        {{ end }}
    </div>

    <!-- Back to Topics -->
    <div class="back-link">
        <a href="{{ "papers/" | relURL }}">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 18l-6-6 6-6"></path>
            </svg>
            Back to all topics
        </a>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>Must-read papers for tech economists and applied researchers</p>
    </footer>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const btnCards = document.getElementById('btn-cards');
    const btnTable = document.getElementById('btn-table');
    const cardsViews = document.querySelectorAll('.cards-view-content');
    const tableViews = document.querySelectorAll('.table-view-content');

    if (!btnCards || !btnTable) return;

    let savedView = 'cards';
    try { savedView = localStorage.getItem('papersDetailView') || 'cards'; } catch(e) {}

    function setView(view) {
        const isCards = view === 'cards';
        cardsViews.forEach(el => el.style.display = isCards ? '' : 'none');
        tableViews.forEach(el => el.style.display = isCards ? 'none' : '');
        btnCards.classList.toggle('active', isCards);
        btnTable.classList.toggle('active', !isCards);
    }

    btnCards.addEventListener('click', function() {
        setView('cards');
        try { localStorage.setItem('papersDetailView', 'cards'); } catch(e) {}
    });

    btnTable.addEventListener('click', function() {
        setView('table');
        try { localStorage.setItem('papersDetailView', 'table'); } catch(e) {}
    });

    if (savedView === 'table') setView('table');
});
</script>
{{ end }}
